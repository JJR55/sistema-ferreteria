{% extends "layout.html" %}

{% block title %}Usuarios - Sistema Ferreter√≠a{% endblock %}

{% block page_title %}üõ°Ô∏è Gesti√≥n de Usuarios{% endblock %}

{% block breadcrumb %}Usuarios{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Toolbar -->
    <div class="card shadow-sm mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Administraci√≥n de Cuentas de Usuario</h5>
            <button class="btn btn-success" id="add-user-btn">
                <i class="bi bi-person-plus-fill"></i> Agregar Usuario
            </button>
        </div>
    </div>

    <!-- Tabla de Usuarios -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> Lista de Usuarios</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre de Usuario</th>
                            <th>Rol</th>
                            <th>Fecha de Creaci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <!-- Filas se insertar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar/Editar Usuario -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">Agregar Nuevo Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="user-form">
                    <input type="hidden" id="user-id">
                    <div class="mb-3">
                        <label for="username" class="form-label">Nombre de Usuario</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Contrase√±a</label>
                        <input type="password" class="form-control" id="password" placeholder="M√≠nimo 6 caracteres">
                        <small id="password-help" class="form-text text-muted">Dejar en blanco para no cambiar la contrase√±a existente.</small>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Rol</label>
                        <select class="form-select" id="role" required>
                            <option value="Vendedor">Vendedor</option>
                            <option value="Almacenista">Almacenista</option>
                            <option value="Administrador">Administrador</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-user-btn">Guardar Usuario</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const userModal = new bootstrap.Modal(document.getElementById('userModal'));

    const fetchUsers = async () => {
        try {
            const response = await fetch('/api/users');
            const result = await response.json();
            if (result.success) {
                renderTable(result.users);
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            console.error('Error de red:', error);
        }
    };

    const getRoleBadge = (role) => {
        const roles = {
            'Administrador': 'bg-danger',
            'Vendedor': 'bg-success',
            'Almacenista': 'bg-info'
        };
        return `<span class="badge ${roles[role] || 'bg-secondary'}">${role}</span>`;
    };

    const renderTable = (users) => {
        const tableBody = document.getElementById('users-table-body');
        tableBody.innerHTML = '';
        users.forEach(user => {
            const row = `
                <tr>
                    <td><strong>${user.nombre_usuario}</strong></td>
                    <td>${getRoleBadge(user.rol)}</td>
                    <td>${new Date(user.fecha_creacion).toLocaleDateString('es-DO')}</td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${user._id}" data-name="${user.nombre_usuario}" title="Eliminar Usuario">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    };

    document.getElementById('add-user-btn').addEventListener('click', () => {
        document.getElementById('user-form').reset();
        document.getElementById('user-id').value = '';
        document.getElementById('userModalLabel').textContent = 'Agregar Nuevo Usuario';
        document.getElementById('password').required = true;
        document.getElementById('password-help').style.display = 'none';
        userModal.show();
    });

    document.getElementById('save-user-btn').addEventListener('click', async () => {
        const data = {
            username: document.getElementById('username').value,
            password: document.getElementById('password').value,
            role: document.getElementById('role').value,
        };

        if (!data.username || !data.password || !data.role) {
            alert('Todos los campos son obligatorios.');
            return;
        }

        try {
            const response = await fetch('/api/users/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                alert(result.message);
                userModal.hide();
                fetchUsers();
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            alert('Error de red al guardar el usuario.');
        }
    });

    document.getElementById('users-table-body').addEventListener('click', async (e) => {
        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
            const userId = deleteBtn.dataset.id;
            const userName = deleteBtn.dataset.name;

            if (confirm(`¬øEst√° seguro de que desea eliminar al usuario "${userName}"? Esta acci√≥n no se puede deshacer.`)) {
                try {
                    const response = await fetch(`/api/users/delete/${userId}`, { method: 'POST' });
                    const result = await response.json();
                    if (result.success) {
                        alert(result.message);
                        fetchUsers();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Error de red al eliminar el usuario.');
                }
            }
        }
    });

    fetchUsers();
});
</script>
{% endblock %}
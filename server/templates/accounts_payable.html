{% extends "layout.html" %} 

{% block title %}Cuentas por Pagar - Sistema Ferreter칤a{% endblock %}

{% block page_title %}游늯 Cuentas por Pagar{% endblock %}

{% block breadcrumb %}Cuentas por Pagar{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <button class="btn btn-outline-secondary" id="add-supplier-main-btn">
        <i class="bi bi-person-plus"></i> Agregar Proveedor
    </button>
    <button class="btn btn-outline-primary" onclick="location.reload()">
        <i class="bi bi-arrow-clockwise"></i> Refrescar
    </button>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#invoiceModal">
        <i class="bi bi-plus-circle"></i> Agregar Factura
    </button>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- KPIs y Tasa de Cambio -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="kpi-card danger">
                <div class="kpi-icon"><i class="bi bi-currency-dollar"></i></div>
                <div class="kpi-content">
                    <h3 id="total-debt-dop">RD$ 0.00</h3>
                    <p class="kpi-label">Deuda Total (DOP)</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="kpi-card warning">
                <div class="kpi-icon"><i class="bi bi-currency-dollar"></i></div>
                <div class="kpi-content">
                    <h3 id="total-debt-usd">US$ 0.00</h3>
                    <p class="kpi-label">Deuda Total (USD)</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="kpi-card info">
                <div class="kpi-icon"><i class="bi bi-graph-up"></i></div>
                <div class="kpi-content">
                    <h3 id="exchange-rate">Cargando...</h3>
                    <p class="kpi-label">Tasa D칩lar (USD a DOP)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pesta침as de Navegaci칩n -->
    <ul class="nav nav-tabs mb-4" id="accountsPayableTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab" aria-controls="pending" aria-selected="true">
                <i class="bi bi-hourglass-split"></i> Facturas Pendientes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="paid-tab" data-bs-toggle="tab" data-bs-target="#paid" type="button" role="tab" aria-controls="paid" aria-selected="false">
                <i class="bi bi-check-circle"></i> Historial de Pagos
            </button>
        </li>
    </ul>

    <!-- Contenido de las Pesta침as -->
    <div class="tab-content" id="accountsPayableTabContent">
        <!-- Pesta침a de Pendientes -->
        <div class="tab-pane fade show active" id="pending" role="tabpanel" aria-labelledby="pending-tab">
            <!-- Panel de b칰squeda y filtros -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="search-input" class="form-control" placeholder="Buscar por proveedor, n칰mero de factura...">
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <select class="form-select" id="status-filter">
                                <option value="">Filtrar por estado...</option>
                                <option value="vence_hoy">Vence hoy</option>
                                <option value="proxima_semana">Pr칩xima semana</option>
                                <option value="vencidas">Vencidas</option>
                                <option value="vigentes">Vigentes</option>
                            </select>
                        </div>
                        <div class="col-lg-3">
                            <button class="btn btn-outline-primary w-100" id="export-pdf-btn">
                                <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de cuentas por pagar -->
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-receipt"></i> Facturas Pendientes</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Proveedor</th>
                                    <th>No. Factura</th>
                                    <th>Fecha Emisi칩n</th>
                                    <th>Vencimiento</th>
                                    <th>Estado</th>
                                    <th>Monto</th>
                                    <th>Moneda</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="accounts-payable-table-body">
                                <!-- Las filas se insertar치n aqu칤 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Pesta침a de Pagadas -->
        <div class="tab-pane fade" id="paid" role="tabpanel" aria-labelledby="paid-tab">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-archive"></i> Historial de Facturas Pagadas</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Proveedor</th>
                                    <th>No. Factura</th>
                                    <th>Fecha Pago</th>
                                    <th>Monto</th>
                                </tr>
                            </thead>
                            <tbody id="paid-invoices-body">
                                <!-- Historial se cargar치 aqu칤 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Factura -->
<div class="modal fade" id="editAccountModal" tabindex="-1" aria-labelledby="editAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAccountModalLabel"><i class="bi bi-pencil-square"></i> Editar Factura por Pagar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-account-form">
                    <input type="hidden" id="edit-factura-id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-proveedor" class="form-label">Proveedor</label>
                            <select class="form-select" id="edit-proveedor" required></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-numero-factura" class="form-label">N칰mero de Factura</label>
                            <input type="text" class="form-control" id="edit-numero-factura" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-fecha-emision" class="form-label">Fecha de Emisi칩n</label>
                            <input type="date" class="form-control" id="edit-fecha-emision" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-fecha-vencimiento" class="form-label">Fecha de Vencimiento</label>
                            <input type="date" class="form-control" id="edit-fecha-vencimiento" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-monto" class="form-label">Monto</label>
                            <div class="input-group">
                                <span class="input-group-text">RD$</span>
                                <input type="number" class="form-control" id="edit-monto" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="moneda" class="form-label">Moneda</label>
                            <select class="form-select" id="edit-moneda">
                                <option value="DOP">DOP</option>
                                <option value="USD">USD</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-edit-account-btn">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    let allAccountsPayable = [];
    const editModal = new bootstrap.Modal(document.getElementById('editAccountModal'));
    const currencyFormatter = new Intl.NumberFormat('es-DO', { style: 'currency', currency: 'DOP' });

    async function fetchAccountsPayable() {
        try {
            const response = await fetch('/api/accounts_payable');
            if (!response.ok) throw new Error('Network response was not ok');
            allAccountsPayable = await response.json();
            renderPage(allAccountsPayable);
        } catch (error) {
            console.error('Error fetching accounts payable:', error);
        }
    }

    async function fetchExchangeRate() {
        try {
            const response = await fetch('https://open.er-api.com/v6/latest/USD');
            if (!response.ok) throw new Error('API de tasa de cambio no disponible');
            const data = await response.json();
            const rate = data.rates.DOP;
            document.getElementById('exchange-rate').textContent = currencyFormatter.format(rate);
        } catch (error) {
            console.error('Error fetching exchange rate:', error);
            document.getElementById('exchange-rate').textContent = 'Error';
        }
    }

    function renderPage(data) {
        const tableBody = document.getElementById('accounts-payable-table-body');
        if (!tableBody) return;
        tableBody.innerHTML = '';

        let totalDOP = 0;
        let totalUSD = 0;

        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);

        data.forEach(cuenta => {
            // Sumar a los totales
            if (cuenta.moneda === 'DOP') {
                totalDOP += cuenta.monto;
            } else if (cuenta.moneda === 'USD') {
                totalUSD += cuenta.monto;
            }

            const fechaVencimiento = new Date(cuenta.fecha_vencimiento);
            fechaVencimiento.setHours(0, 0, 0, 0);

            const tiempoRestante = fechaVencimiento - hoy;
            const diasRestantes = Math.ceil(tiempoRestante / (1000 * 60 * 60 * 24));

            let estadoClass, estadoText;

            if (diasRestantes < 0) {
                estadoClass = 'badge bg-danger';
                estadoText = `Vencida (${Math.abs(diasRestantes)} d칤as)`;
            } else if (diasRestantes === 0) {
                estadoClass = 'badge bg-warning text-dark';
                estadoText = 'Vence Hoy';
            } else {
                estadoClass = 'badge bg-success';
                estadoText = `Vigente (${diasRestantes} d칤as)`;
            }

            const row = document.createElement('tr');
            if (diasRestantes < 0) row.classList.add('table-danger');

            row.innerHTML = `
                <td>${cuenta.proveedor}</td>
                <td>${cuenta.numero_factura}</td>
                <td>${new Date(cuenta.fecha_emision).toLocaleDateString('es-DO')}</td>
                <td>${new Date(cuenta.fecha_vencimiento).toLocaleDateString('es-DO')}</td>
                <td><span class="${estadoClass}">${estadoText}</span></td>
                <td>${(cuenta.moneda === 'USD' ? 'US$ ' : 'RD$ ') + cuenta.monto.toFixed(2)}</td>
                <td>${cuenta.moneda}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary btn-edit" data-id="${cuenta._id}" title="Editar">
                        <i class="bi bi-pencil-fill"></i>
                    </button>
                    <button class="btn btn-sm btn-success btn-pay" data-id="${cuenta._id}" title="Marcar como Pagada">
                        <i class="bi bi-check-lg"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        // Actualizar KPIs
        document.getElementById('total-debt-dop').textContent = currencyFormatter.format(totalDOP);
        document.getElementById('total-debt-usd').textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(totalUSD);
    }

    async function markAsPaid(facturaId) {
        if (!confirm('쮼st치 seguro de que desea marcar esta factura como pagada?')) return;

        try {
            const response = await fetch(`/api/accounts_payable/pay/${facturaId}`, { method: 'POST' });
            const result = await response.json();
            if (result.success) {
                fetchAccountsPayable(); // Recargar la tabla
            } else {
                alert('Error al marcar como pagada: ' + result.error);
            }
        } catch (error) {
            console.error('Error de red:', error);
        }
    }

    // Delegaci칩n de eventos para la tabla
    document.getElementById('accounts-payable-table-body').addEventListener('click', function (e) {
        const editBtn = e.target.closest('.btn-edit');
        const payBtn = e.target.closest('.btn-pay');

        if (editBtn) {
            const facturaId = editBtn.dataset.id;
            const cuenta = allAccountsPayable.find(c => c._id === facturaId);
            if (cuenta) {
                // Llenar y mostrar el modal de edici칩n (l칩gica completa necesaria aqu칤)
                console.log('Editando:', cuenta);
                editModal.show();
            }
        }

        if (payBtn) {
            const facturaId = payBtn.dataset.id;
            markAsPaid(facturaId);
        }
    });

    // Filtros y b칰squeda
    document.getElementById('search-input').addEventListener('keyup', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allAccountsPayable.filter(c =>
            c.proveedor.toLowerCase().includes(term) ||
            c.numero_factura.toLowerCase().includes(term)
        );
        renderPage(filtered);
    });

    // Carga inicial
    fetchAccountsPayable();
    fetchExchangeRate();

    // Cargar facturas pagadas al mostrar la pesta침a de historial
    async function fetchPaidInvoices() {
        try {
            const resp = await fetch('/api/accounts_payable/paid');
            if (!resp.ok) throw new Error('No se pudo obtener facturas pagadas');
            const paid = await resp.json();
            renderPaidInvoices(paid);
        } catch (err) {
            console.error('Error cargando facturas pagadas:', err);
        }
    }

    function renderPaidInvoices(data) {
        const tbody = document.getElementById('paid-invoices-body');
        tbody.innerHTML = '';
        data.forEach(f => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${f.proveedor}</td>
                <td>${f.numero_factura}</td>
                <td>${f.fecha_pago ? new Date(f.fecha_pago).toLocaleDateString('es-DO') : ''}</td>
                <td>${(f.moneda === 'USD' ? 'US$ ' : 'RD$ ') + (f.monto || 0).toFixed(2)}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // Actualizar historial al cambiar a la pesta침a "Pagadas"
    document.getElementById('paid-tab').addEventListener('shown.bs.tab', function () {
        fetchPaidInvoices();
    });

});
</script>
{% endblock %}

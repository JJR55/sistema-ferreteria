{% extends "layout.html" %} 

{% block title %}Cuentas por Pagar - Sistema Ferreter칤a{% endblock %}

{% block page_title %}游늯 Cuentas por Pagar{% endblock %}

{% block breadcrumb %}Cuentas por Pagar{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
    </div>
    <div>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#invoiceModal">
            <i class="bi bi-plus-circle"></i> Agregar Factura
        </button>
    </div>
</div>
<div class="container-fluid">
    <!-- KPIs y Tasa de Cambio -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="kpi-card danger">
                <div class="kpi-icon"><i class="bi bi-currency-dollar"></i></div>
                <div class="kpi-content">
                    <h3 id="total-debt-dop">RD$ 0.00</h3>
                    <p class="kpi-label">Deuda Total (DOP)</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="kpi-card warning">
                <div class="kpi-icon"><i class="bi bi-currency-dollar"></i></div>
                <div class="kpi-content">
                    <h3 id="total-debt-usd">US$ 0.00</h3>
                    <p class="kpi-label">Deuda Total (USD)</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="kpi-card info">
                <div class="kpi-icon"><i class="bi bi-graph-up"></i></div>
                <div class="kpi-content">
                    <h3 id="exchange-rate">Cargando...</h3>
                    <p class="kpi-label">Tasa D칩lar (USD a DOP)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pesta침as de Navegaci칩n -->
    <ul class="nav nav-tabs mb-4" id="accountsPayableTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab" aria-controls="pending" aria-selected="true">
                <i class="bi bi-hourglass-split"></i> Facturas Pendientes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="paid-tab" data-bs-toggle="tab" data-bs-target="#paid" type="button" role="tab" aria-controls="paid" aria-selected="false">
                <i class="bi bi-check-circle"></i> Historial de Pagos
            </button>
        </li>
    </ul>

    <!-- Contenido de las Pesta침as -->
    <div class="tab-content" id="accountsPayableTabContent">
        <!-- Pesta침a de Pendientes -->
        <div class="tab-pane fade show active" id="pending" role="tabpanel" aria-labelledby="pending-tab">
            <!-- Panel de b칰squeda y filtros -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="search-input" class="form-control" placeholder="Buscar por proveedor, n칰mero de factura...">
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <select class="form-select" id="status-filter">
                                <option value="">Filtrar por estado...</option>
                                <option value="vence_hoy">Vence hoy</option>
                                <option value="proxima_semana">Pr칩xima semana</option>
                                <option value="vencidas">Vencidas</option>
                                <option value="vigentes">Vigentes</option>
                            </select>
                        </div>
                        <div class="col-lg-3">
                            <button class="btn btn-outline-primary w-100" id="export-pdf-btn">
                                <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de cuentas por pagar -->
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-receipt"></i> Facturas Pendientes</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Proveedor</th>
                                    <th>No. Factura</th>
                                    <th>Fecha Emisi칩n</th>
                                    <th>Vencimiento</th>
                                    <th>Estado</th>
                                    <th>Monto</th>
                                    <th>Moneda</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="accounts-payable-table-body">
                                <!-- Las filas se insertar치n aqu칤 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Pesta침a de Pagadas -->
        <div class="tab-pane fade" id="paid" role="tabpanel" aria-labelledby="paid-tab">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-archive"></i> Historial de Facturas Pagadas</h5>
                </div>
                <div class="card-body p-0">
                    <div class="p-3">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-4">
                                <label for="paid-start-date" class="form-label visually-hidden">Fecha Inicio</label>
                                <input type="date" class="form-control" id="paid-start-date" title="Fecha de inicio">
                            </div>
                            <div class="col-md-4">
                                <label for="paid-end-date" class="form-label visually-hidden">Fecha Fin</label>
                                <input type="date" class="form-control" id="paid-end-date" title="Fecha de fin">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-primary w-100" id="filter-paid-invoices-btn">
                                    <i class="bi bi-funnel"></i> Filtrar Historial
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Proveedor</th>
                                    <th>No. Factura</th>
                                    <th>Monto Pagado</th>
                                    <th>Fecha Emisi칩n</th>
                                    <th>Fecha Pago</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="paid-invoices-table-body">
                                <!-- Historial se cargar치 aqu칤 -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Mensaje cuando no hay facturas pagadas -->
                    <div id="empty-paid-state" class="text-center p-5 text-muted" style="display: none;">
                        <p>No hay facturas pagadas recientemente.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar Factura -->
<div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoiceModalLabel"><i class="bi bi-receipt-cutoff"></i> Registrar Nueva Factura por Pagar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="invoice-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="proveedor" class="form-label">Proveedor</label>
                            <select class="form-select" id="proveedor" required></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="numero-factura" class="form-label">N칰mero de Factura</label>
                            <input type="text" class="form-control" id="numero-factura" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fecha-emision" class="form-label">Fecha de Emisi칩n</label>
                            <input type="date" class="form-control" id="fecha-emision" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fecha-vencimiento" class="form-label">Fecha de Vencimiento</label>
                            <input type="date" class="form-control" id="fecha-vencimiento" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="monto" class="form-label">Monto</label>
                            <div class="input-group">
                                <input type="text" inputmode="decimal" class="form-control" id="monto" placeholder="11,500.00" required>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="moneda" class="form-label">Moneda</label>
                            <select class="form-select" id="moneda">
                                <option value="DOP">DOP</option>
                                <option value="USD">USD</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notas" class="form-label">Notas (Opcional)</label>
                        <textarea class="form-control" id="notas" rows="2" placeholder="Ej: Pago parcial realizado, contactar antes de pagar..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-invoice-btn">Guardar Factura</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Factura -->
<div class="modal fade" id="editAccountModal" tabindex="-1" aria-labelledby="editAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAccountModalLabel"><i class="bi bi-pencil-square"></i> Editar Factura por Pagar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-account-form">
                    <input type="hidden" id="edit-factura-id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-proveedor" class="form-label">Proveedor</label>
                            <select class="form-select" id="edit-proveedor" required></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-numero-factura" class="form-label">N칰mero de Factura</label>
                            <input type="text" class="form-control" id="edit-numero-factura" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-fecha-emision" class="form-label">Fecha de Emisi칩n</label>
                            <input type="date" class="form-control" id="edit-fecha-emision" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-fecha-vencimiento" class="form-label">Fecha de Vencimiento</label>
                            <input type="date" class="form-control" id="edit-fecha-vencimiento" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-monto" class="form-label">Monto</label>
                            <div class="input-group"> 
                                <input type="text" inputmode="decimal" class="form-control" id="edit-monto" placeholder="11,500.00" required>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="moneda" class="form-label">Moneda</label>
                            <select class="form-select" id="edit-moneda">
                                <option value="DOP">DOP</option>
                                <option value="USD">USD</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit-notas" class="form-label">Notas (Opcional)</label>
                        <textarea class="form-control" id="edit-notas" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-edit-account-btn">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    let allAccountsPayable = [];
    const editModal = new bootstrap.Modal(document.getElementById('editAccountModal'));
    const currencyFormatter = new Intl.NumberFormat('es-DO', { style: 'currency', currency: 'DOP' });

    async function fetchAccountsPayable() {
        try {
            const response = await fetch('/api/accounts_payable');
            if (!response.ok) throw new Error('Network response was not ok');
            allAccountsPayable = await response.json();
            renderPage(allAccountsPayable);
        } catch (error) {
            console.error('Error fetching accounts payable:', error);
        }
    }

    async function fetchExchangeRate() {
        try {
            const response = await fetch('https://open.er-api.com/v6/latest/USD');
            if (!response.ok) throw new Error('API de tasa de cambio no disponible');
            const data = await response.json();
            const rate = data.rates.DOP;
            document.getElementById('exchange-rate').textContent = currencyFormatter.format(rate);
        } catch (error) {
            console.error('Error fetching exchange rate:', error);
            document.getElementById('exchange-rate').textContent = 'Error';
        }
    }

    function renderPage(data) {
        const tableBody = document.getElementById('accounts-payable-table-body');
        if (!tableBody) return;
        tableBody.innerHTML = '';

        let totalDOP = 0;
        let totalUSD = 0;

        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);

        data.forEach(cuenta => {
            // Sumar a los totales
            if (cuenta.moneda === 'DOP') {
                totalDOP += cuenta.monto;
            } else if (cuenta.moneda === 'USD') {
                totalUSD += cuenta.monto;
            }

            const fechaVencimiento = new Date(cuenta.fecha_vencimiento);
            fechaVencimiento.setHours(0, 0, 0, 0);

            const tiempoRestante = fechaVencimiento - hoy;
            const diasRestantes = Math.ceil(tiempoRestante / (1000 * 60 * 60 * 24));

            let estadoClass, estadoText;

            if (diasRestantes < 0) {
                estadoClass = 'badge bg-danger';
                estadoText = `Vencida (${Math.abs(diasRestantes)} d칤as)`;
            } else if (diasRestantes === 0) {
                estadoClass = 'badge bg-warning text-dark';
                estadoText = 'Vence Hoy';
            } else {
                estadoClass = 'badge bg-success';
                estadoText = `Vigente (${diasRestantes} d칤as)`;
            }

            const row = document.createElement('tr');
            if (diasRestantes < 0) row.classList.add('table-danger');

            row.innerHTML = `
                <td>
                    ${cuenta.proveedor}
                    ${cuenta.notas ? `<i class="bi bi-info-circle-fill text-primary ms-1" title="${cuenta.notas}" data-bs-toggle="tooltip"></i>` : ''}
                </td>
                <td>${cuenta.numero_factura}</td>
                <td>${cuenta.fecha_emision ? new Date(cuenta.fecha_emision).toLocaleDateString('es-DO') : ''}</td>
                <td>${new Date(cuenta.fecha_vencimiento).toLocaleDateString('es-DO')}</td>
                <td><span class="${estadoClass}">${estadoText}</span></td>
                <td>${(cuenta.moneda === 'USD' ? 'US$ ' : 'RD$ ') + (cuenta.monto || 0).toLocaleString('es-DO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td>${cuenta.moneda}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary btn-edit" data-id="${cuenta._id}" title="Editar">
                        <i class="bi bi-pencil-fill"></i>
                    </button>
                    <button class="btn btn-sm btn-success btn-pay" data-id="${cuenta._id}" title="Marcar como Pagada">
                        <i class="bi bi-check-lg"></i>
                    </button>
                    <button class="btn btn-sm btn-danger btn-delete" data-id="${cuenta._id}" data-invoice="${cuenta.numero_factura}" title="Eliminar">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        // Re-inicializar tooltips para las nuevas notas
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Actualizar KPIs
        document.getElementById('total-debt-dop').textContent = currencyFormatter.format(totalDOP);
        document.getElementById('total-debt-usd').textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(totalUSD);
    }

    async function markAsPaid(facturaId) {
        if (!confirm('쮼st치 seguro de que desea marcar esta factura como pagada?')) return;

        try {
            const response = await fetch(`/api/accounts_payable/pay/${facturaId}`, { method: 'POST' });
            const result = await response.json();
            if (result.success) {
                fetchAccountsPayable(); // Recargar la tabla
            } else {
                alert('Error al marcar como pagada: ' + result.error);
            }
        } catch (error) {
            console.error('Error de red:', error);
        }
    }

    // Delegaci칩n de eventos para la tabla
    document.getElementById('accounts-payable-table-body').addEventListener('click', function (e) {
        const editBtn = e.target.closest('.btn-edit');
        const payBtn = e.target.closest('.btn-pay');
        const deleteBtn = e.target.closest('.btn-delete');

        if (editBtn) {
            const facturaId = editBtn.dataset.id;
            const cuenta = allAccountsPayable.find(c => c._id === facturaId);
            if (cuenta) {
                // Rellenar formulario de edici칩n
                document.getElementById('edit-factura-id').value = facturaId;
                document.getElementById('edit-proveedor').value = cuenta.proveedor_id || '';
                document.getElementById('edit-numero-factura').value = cuenta.numero_factura || '';
                document.getElementById('edit-fecha-emision').value = cuenta.fecha_emision ? cuenta.fecha_emision.split('T')[0] : '';
                document.getElementById('edit-fecha-vencimiento').value = cuenta.fecha_vencimiento ? cuenta.fecha_vencimiento.split('T')[0] : '';
                document.getElementById('edit-monto').value = cuenta.monto || '';
                document.getElementById('edit-moneda').value = cuenta.moneda || 'DOP';
                document.getElementById('edit-notas').value = cuenta.notas || '';
                editModal.show();
            }
        }

        if (payBtn) {
            const facturaId = payBtn.dataset.id;
            markAsPaid(facturaId);
        }

        if (deleteBtn) {
            const facturaId = deleteBtn.dataset.id;
            const numeroFactura = deleteBtn.dataset.invoice;
            if (confirm(`쮼st치 seguro de que desea eliminar la factura N춿 ${numeroFactura}? Esta acci칩n no se puede deshacer.`)) {
                fetch(`/api/accounts_payable/delete/${facturaId}`, { method: 'POST' })
                    .then(res => res.json())
                    .then(result => {
                        if (result.success) { alert(result.message); fetchAccountsPayable(); }
                        else { alert('Error: ' + result.error); }
                    })
                    .catch(err => alert('Error de red al eliminar.'));
            }
        }
    });

    // Filtros y b칰squeda
    document.getElementById('search-input').addEventListener('keyup', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allAccountsPayable.filter(c =>
            c.proveedor.toLowerCase().includes(term) ||
            c.numero_factura.toLowerCase().includes(term)
        );
        renderPage(filtered);
    });

    document.getElementById('status-filter').addEventListener('change', (e) => {
        const filter = e.target.value;
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        const proximaSemana = new Date(hoy);
        proximaSemana.setDate(hoy.getDate() + 7);

        let filtered = allAccountsPayable;

        if (filter === 'vencidas') {
            filtered = allAccountsPayable.filter(c => new Date(c.fecha_vencimiento) < hoy);
        } else if (filter === 'vence_hoy') {
            filtered = allAccountsPayable.filter(c => {
                const fechaVenc = new Date(c.fecha_vencimiento);
                fechaVenc.setHours(0,0,0,0);
                return fechaVenc.getTime() === hoy.getTime();
            });
        } else if (filter === 'proxima_semana') {
            filtered = allAccountsPayable.filter(c => {
                const fechaVenc = new Date(c.fecha_vencimiento);
                return fechaVenc >= hoy && fechaVenc <= proximaSemana;
            });
        } else if (filter === 'vigentes') {
            filtered = allAccountsPayable.filter(c => new Date(c.fecha_vencimiento) >= hoy);
        }

        renderPage(filtered);
    });

    document.getElementById('export-pdf-btn').addEventListener('click', () => {
        alert('Funcionalidad de exportar a PDF pendiente de implementaci칩n.');
    });

    // Carga inicial
    fetchAccountsPayable();
    fetchExchangeRate();
    fetchSuppliers();

    // Funci칩n para obtener proveedores y poblar los selects del modal
    async function fetchSuppliers() {
        try {
            const resp = await fetch('/api/suppliers');
            if (!resp.ok) throw new Error('No se pudieron obtener proveedores');
            const suppliers = await resp.json();
            const proveedorSelect = document.getElementById('proveedor');
            const editProveedorSelect = document.getElementById('edit-proveedor');
            if (proveedorSelect) proveedorSelect.innerHTML = '';
            if (editProveedorSelect) editProveedorSelect.innerHTML = '';

            suppliers.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s._id;
                opt.textContent = s.nombre || s.name || 'Proveedor';
                if (proveedorSelect) proveedorSelect.appendChild(opt);

                const opt2 = opt.cloneNode(true);
                if (editProveedorSelect) editProveedorSelect.appendChild(opt2);
            });
        } catch (err) {
            console.error('Error fetching suppliers:', err);
        }
    }

    // Adjuntar validadores para permitir comas y puntos en input de monto
    function attachNumericWithComma(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('input', (e) => {
            // permitir s칩lo d칤gitos, punto y coma
            const cleaned = e.target.value.replace(/[^0-9.,]/g, '');
            if (cleaned !== e.target.value) e.target.value = cleaned;
        });
        el.addEventListener('blur', (e) => {
            // quitar espacios y normalizar m칰ltiples comas
            e.target.value = e.target.value.trim();
        });
    }

    attachNumericWithComma('monto');
    attachNumericWithComma('edit-monto');

    // Listener para guardar cambios en factura editada
    document.getElementById('save-edit-account-btn').addEventListener('click', async function () {
        const facturaId = document.getElementById('edit-factura-id').value;
        const proveedor = document.getElementById('edit-proveedor').value;
        const numero = document.getElementById('edit-numero-factura').value;
        const fechaEmision = document.getElementById('edit-fecha-emision').value;
        const fechaVenc = document.getElementById('edit-fecha-vencimiento').value;
        const montoRaw = document.getElementById('edit-monto').value || '';
        const monto = parseFloat(montoRaw.replace(/,/g, '')) || 0;
        const moneda = document.getElementById('edit-moneda').value;
        const notas = document.getElementById('edit-notas').value;

        if (!facturaId || !proveedor || !numero || !fechaEmision || !fechaVenc || !monto) {
            alert('Por favor complete todos los campos requeridos.');
            return;
        }

        try {
            const resp = await fetch(`/api/accounts_payable/update/${facturaId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    proveedor_id: proveedor,
                    numero_factura: numero,
                    fecha_emision: fechaEmision,
                    fecha_vencimiento: fechaVenc,
                    monto: monto,
                    moneda: moneda,
                    notas: notas
                })
            });
            const result = await resp.json();
            console.log('Update response:', result);
            if (result.success) {
                editModal.hide();
                // Peque침o delay para asegurar que la BD actualiz칩
                await new Promise(resolve => setTimeout(resolve, 500));
                await fetchAccountsPayable();
                alert('Factura actualizada exitosamente.');
            } else {
                alert('Error al actualizar factura: ' + (result.error || 'Error desconocido'));
            }
        } catch (err) {
            console.error('Error updating invoice:', err);
            alert('Error de red al actualizar la factura.');
        }
    });

    // Guardar nueva factura desde el modal
    document.getElementById('save-invoice-btn').addEventListener('click', async function () {
        const proveedor = document.getElementById('proveedor').value;
        const numero = document.getElementById('numero-factura').value;
        const fechaEmision = document.getElementById('fecha-emision').value;
        const fechaVenc = document.getElementById('fecha-vencimiento').value;
        // Aceptar formatos con comas de miles: "11,500.00" o "11500.00"
        const montoRaw = document.getElementById('monto').value || '';
        const monto = parseFloat(montoRaw.replace(/,/g, '')) || 0;
        const moneda = document.getElementById('moneda').value;
        const notas = document.getElementById('notas').value;

        if (!proveedor || !numero || !fechaEmision || !fechaVenc || !monto) {
            alert('Por favor complete todos los campos requeridos.');
            return;
        }

        try {
            const resp = await fetch('/api/accounts_payable/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    proveedor_id: proveedor,
                    numero_factura: numero,
                    fecha_emision: fechaEmision,
                    fecha_vencimiento: fechaVenc,
                    monto: monto,
                    moneda: moneda,
                    notas: notas
                })
            });
            const result = await resp.json();
            if (result.success) {
                // Cerrar modal y refrescar lista
                const invoiceModalEl = document.getElementById('invoiceModal');
                const invoiceModal = bootstrap.Modal.getInstance(invoiceModalEl);
                invoiceModal.hide();
                fetchAccountsPayable();
            } else {
                alert('Error al guardar factura: ' + (result.error || 'Error desconocido'));
            }
        } catch (err) {
            console.error('Error saving invoice:', err);
            alert('Error de red al guardar la factura.');
        }
    });

    // Cargar facturas pagadas al mostrar la pesta침a de historial
    async function fetchPaidInvoices() {
        try {
            const resp = await fetch('/api/accounts_payable/paid');
            if (!resp.ok) throw new Error('No se pudo obtener facturas pagadas');
            const paid = await resp.json();
            renderPaidInvoices(paid);
        } catch (err) {
            console.error('Error cargando facturas pagadas:', err);
        }
    }

    // Cargar facturas pagadas al mostrar la pesta침a de historial
    async function fetchPaidInvoices() {
        try {
            const startDate = document.getElementById('paid-start-date').value;
            const endDate = document.getElementById('paid-end-date').value;

            let url = '/api/accounts_payable/paid';
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            if (params.toString()) {
                url += '?' + params.toString();
            }

            const resp = await fetch(url);
            if (!resp.ok) throw new Error('No se pudo obtener facturas pagadas');
            const paid = await resp.json();
            renderPaidInvoices(paid);
        } catch (err) {
            console.error('Error cargando facturas pagadas:', err);
        }
    }

    function renderPaidInvoices(data) {
        const tbody = document.getElementById('paid-invoices-table-body');
        const emptyStateDiv = document.getElementById('empty-paid-state');
        tbody.innerHTML = '';

        if (data.length === 0) {
            emptyStateDiv.style.display = 'block';
            // Opcional: ocultar la tabla si no hay datos y solo mostrar el mensaje
            // document.querySelector('#paid-invoices-table-container table').style.display = 'none';
        } else {
            emptyStateDiv.style.display = 'none';
            // document.querySelector('#paid-invoices-table-container table').style.display = 'table';

            data.forEach(f => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${f.proveedor}</td>
                    <td>${f.numero_factura}</td>
                    <td>${(f.moneda === 'USD' ? 'US$ ' : 'RD$ ') + (f.monto || 0).toLocaleString('es-DO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>${f.fecha_emision ? new Date(f.fecha_emision).toLocaleDateString('es-DO') : ''}</td>
                    <td>${f.fecha_pago ? new Date(f.fecha_pago).toLocaleDateString('es-DO') : ''}</td>
                    <td><span class="badge bg-success">Pagada</span></td>
                `;
                tbody.appendChild(row);
            });
        }
    }

    // Actualizar historial al cambiar a la pesta침a "Pagadas"
    document.getElementById('paid-tab').addEventListener('shown.bs.tab', function () {
        fetchPaidInvoices();
    });

    // Add event listener for the new filter button
    document.getElementById('filter-paid-invoices-btn').addEventListener('click', function() {
        fetchPaidInvoices();
    });

});
</script>

{% endblock %}

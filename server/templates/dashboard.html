<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Inventario</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #1a1a1a; color: #f0f0f0; margin: 0; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        header { background-color: #2a2d2e; padding: 15px 30px; color: white; font-size: 1.5em; border-bottom: 1px solid #3a3d3e; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background-color: #2a2d2e; padding: 25px; border-radius: 8px; border: 1px solid #3a3d3e; }
        .stat-card h3 { margin-top: 0; color: #a0a0a0; font-size: 1em; }
        .stat-card p { margin-bottom: 0; font-size: 2em; font-weight: bold; color: #3484F0; }
        table { width: 100%; border-collapse: collapse; background-color: #2a2d2e; border-radius: 8px; overflow: hidden; border: 1px solid #3a3d3e;}
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #3a3d3e; }
        tr.low-stock { background-color: #8B0000 !important; }
        th { background-color: #565b5e; }
        tr:last-child td { border-bottom: none; }
        td[contenteditable="true"] { background-color: #4a4d4e; outline: 1px solid #3484F0; }
        .actions button { background-color: #565b5e; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .actions .save-btn { background-color: #3484F0; }
        .actions .cancel-btn { background-color: #D32F2F; }
        .actions .delete-btn { background-color: #B71C1C; }
        .add-form { background-color: #2a2d2e; padding: 20px; border-radius: 8px; border: 1px solid #3a3d3e; margin-bottom: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        .add-form input, .add-form select { width: 100%; padding: 10px; background-color: #3a3d3e; border: 1px solid #565b5e; color: white; border-radius: 4px; box-sizing: border-box; }
        .add-form button { grid-column: -1; background-color: #3484F0; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .add-form label { font-size: 0.9em; color: #a0a0a0; }
        .chart-container { background-color: #2a2d2e; padding: 20px; border-radius: 8px; border: 1px solid #3a3d3e; margin-bottom: 30px; }
        h2 { border-bottom: 2px solid #3484F0; padding-bottom: 10px; }
    </style>
</head>
<body>

    <header>
        Dashboard Ferretería XYZ
    </header>

    <div class="container">
        <h2>Resumen General</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total de Productos</h3>
                <p id="stat-total-productos">Cargando...</p>
            </div>
            <div class="stat-card">
                <h3>Valor del Inventario</h3>
                <p id="stat-valor-inventario">Cargando...</p>
            </div>
            <div class="stat-card">
                <h3>Total de Ventas</h3>
                <p id="stat-total-ventas">Cargando...</p>
            </div>
        </div>

        <h2>Agregar Nuevo Producto</h2>
        <form id="add-product-form" class="add-form">
            <div>
                <label for="codigo">Código de Barras</label>
                <input type="text" id="codigo" name="codigo_barras" required>
            </div>
            <div>
                <label for="nombre">Nombre del Producto</label>
                <input type="text" id="nombre" name="nombre" required>
            </div>
            <div>
                <label for="departamento">Departamento</label>
                <select id="departamento" name="departamento">
                    <option>Ferretería</option>
                    <option>Repuestos</option>
                    <option>Hogar</option>
                </select>
            </div>
            <div>
                <label for="precio">Precio</label>
                <input type="number" id="precio" name="precio" step="0.01" min="0" required>
            </div>
            <div>
                <label for="costo">Costo</label>
                <input type="number" id="costo" name="costo" step="0.01" min="0" required>
            </div>
            <div>
                <label for="stock">Stock Inicial</label>
                <input type="number" id="stock" name="stock" min="0" required>
            </div>
            <button type="submit">Agregar</button>
        </form>

        <h2>Lista de Productos</h2>
        <table>
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Departamento</th>
                    <th>Precio</th>
                    <th>Costo</th>
                    <th>Stock</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="product-table-body">
                <!-- Las filas se insertarán aquí con JavaScript -->
            </tbody>
        </table>
    </div>
    
    <div class="container">
        <h2>Ventas de los Últimos 7 Días</h2>
        <div class="chart-container">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <script>
        let originalRowHTML = {};
        // Función para formatear moneda
        const currencyFormatter = new Intl.NumberFormat('es-DO', {
            style: 'currency',
            currency: 'DOP',
        });

        let salesChart = null; // Variable global para nuestro gráfico

        function fetchStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('stat-total-productos').textContent = data.total_productos;
                    document.getElementById('stat-valor-inventario').textContent = currencyFormatter.format(data.valor_inventario);
                    document.getElementById('stat-total-ventas').textContent = data.total_ventas;
                })
                .catch(error => console.error('Error al refrescar estadísticas:', error));
        }

        function fetchProducts() {
            fetch('/api/products')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('product-table-body');
                    // Aquí guardamos la fila que se está editando para no sobreescribirla
                    const editingRow = tableBody.querySelector('td[contenteditable="true"]');
                    if (editingRow) return; // Si el usuario está editando, no refrescamos la tabla para no interrumpirle.

                    renderTable(data);
                })
                .catch(error => console.error('Error al refrescar productos:', error));
        }

        function fetchSalesChartData() {
            fetch('/api/sales_chart_data')
                .then(response => response.json())
                .then(data => {
                    const labels = data.map(item => new Date(item.dia).toLocaleDateString('es-DO', { weekday: 'short', day: 'numeric' }));
                    const salesData = data.map(item => item.total);

                    const chartCtx = document.getElementById('salesChart').getContext('2d');
                    
                    if (salesChart) {
                        // Si el gráfico ya existe, solo actualizamos los datos
                        salesChart.data.labels = labels;
                        salesChart.data.datasets[0].data = salesData;
                        salesChart.update();
                    } else {
                        // Si no, lo creamos por primera vez
                        salesChart = new Chart(chartCtx, {
                            type: 'bar', // Puedes cambiar a 'line' para un gráfico de líneas
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Total Ventas (RD$)',
                                    data: salesData,
                                    backgroundColor: 'rgba(52, 132, 240, 0.6)',
                                    borderColor: 'rgba(52, 132, 240, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                scales: {
                                    y: { beginAtZero: true }
                                },
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    }
                })
                .catch(error => console.error('Error al cargar datos del gráfico:', error));
        }

        document.getElementById('add-product-form').addEventListener('submit', function(event) {
            event.preventDefault(); // Evitar que la página se recargue

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            fetch('/api/product/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    this.reset(); // Limpiar el formulario
                    location.reload(); // Recargar la página para ver el nuevo producto
                } else {
                    alert(`Error: ${result.error}`);
                }
            })
            .catch(error => console.error('Error al agregar producto:', error));
        });

        function renderTable(products) {
            const tableBody = document.getElementById('product-table-body');
            tableBody.innerHTML = ''; // Limpiar tabla

            products.forEach(product => {
            const row = document.createElement('tr');
                row.setAttribute('data-id', product.id);
                row.innerHTML = `
                    <td>${product.codigo_barras || ''}</td>
                    <td>${product.nombre || ''}</td>
                    <td>RD$ ${product.costo.toFixed(2)}</td>
                    <td>RD$ ${product.precio.toFixed(2)}</td>
                    <td>${product.stock}</td>
                    <td>${product.stock_minimo}</td>
                    <td>${product.departamento || ''}</td>
                    <td class="actions">
                        <button class="edit-btn" onclick="toggleEdit(this, true)">Editar</button>
                        <button class="delete-btn" onclick="deleteProduct(this)">Eliminar</button>
                        <button class="save-btn" style="display:none;" onclick="saveChanges(this)">Guardar</button>
                        <button class="cancel-btn" style="display:none;" onclick="toggleEdit(this, false)">Cancelar</button>
                    </td>
                `;
                if (product.stock < product.stock_minimo) {
                    row.classList.add('low-stock');
                }
                tableBody.appendChild(row);
            });
        }

        // --- INICIO DE LA EJECUCIÓN ---
        // Cargar los datos por primera vez al abrir la página
        fetchStats();
        fetchProducts();
        fetchSalesChartData();

        // Configurar el intervalo para refrescar los datos cada 5 segundos (5000 milisegundos)
        setInterval(fetchStats, 5000);
        setInterval(fetchProducts, 5000);
        setInterval(fetchSalesChartData, 5000); // El gráfico también se actualizará

        function toggleEdit(button, isEditing) {
            const row = button.closest('tr');
            const productId = row.getAttribute('data-id');
            const cells = row.querySelectorAll('td[data-field]');

            if (isEditing) {
                // Guardar el estado original antes de editar
                originalRowHTML[productId] = row.innerHTML;

                cells.forEach(cell => {
                    cell.setAttribute('contenteditable', 'true');
                });
                row.querySelector('.edit-btn').style.display = 'none';
                row.querySelector('.delete-btn').style.display = 'none';
                row.querySelector('.save-btn').style.display = 'inline-block';
                row.querySelector('.cancel-btn').style.display = 'inline-block';
            } else {
                // Restaurar desde el estado guardado (Cancelar)
                if (originalRowHTML[productId]) {
                    row.innerHTML = originalRowHTML[productId];
                }
            }
        }

        function saveChanges(button) {
            const row = button.closest('tr');
            const productId = row.getAttribute('data-id');
            const cells = row.querySelectorAll('td[data-field]');

            const updatedData = { id: productId };
            let isValid = true;

            cells.forEach(cell => {
                const field = cell.getAttribute('data-field');
                const value = cell.textContent.trim();
                updatedData[field] = value;

                // Validación simple
                if (field === 'precio' && isNaN(parseFloat(value))) isValid = false;
                if (field === 'stock' && isNaN(parseInt(value))) isValid = false;
                if (field === 'costo' && isNaN(parseFloat(value))) isValid = false;
            });

            if (!isValid) {
                alert('Error: Precio y Stock deben ser números.');
                return;
            }

            // Enviar los datos al servidor
            fetch(`/api/product/update/${productId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    codigo_barras: updatedData.codigo_barras,
                    nombre: updatedData.nombre,
                    departamento: updatedData.departamento,
                    precio: updatedData.precio,
                    costo: updatedData.costo,
                    stock: updatedData.stock,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Producto actualizado con éxito.');
                    // Salir del modo edición
                    toggleEdit(button, false);
                    // Opcional: recargar toda la tabla para asegurar consistencia
                    // location.reload(); 
                } else {
                    alert(`Error al guardar: ${data.error}`);
                }
            })
            .catch(error => console.error('Error en la petición de guardado:', error));
        }

        function deleteProduct(button) {
            const row = button.closest('tr');
            const productId = row.getAttribute('data-id');
            const productName = row.querySelector('td[data-field="nombre"]').textContent;

            if (confirm(`¿Está seguro de que desea eliminar el producto "${productName}"? Esta acción no se puede deshacer.`)) {
                fetch(`/api/product/delete/${productId}`, {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        // Eliminar la fila de la tabla sin recargar toda la página
                        row.remove(); 
                        fetchStats(); // Forzar actualización de estadísticas después de eliminar
                    } else {
                        alert(`Error al eliminar: ${data.error}`);
                    }
                })
                .catch(error => console.error('Error en la petición de eliminación:', error));
            }
        }
    </script>

</body>
</html>
```
<!--
### ¿Cómo Funciona Todo Junto?

1.  **Dos Programas, un Cerebro:** Aho ra tienes dos puntos de entrada: `main.py` para la aplicación de escritorio y `server.py` para el acceso web. Ambos programas leen y escriben en el mismo archivo de base de datos `ferreteria.db`. Esto es lo que los mantiene sincronizados.
2.  **El Servidor (`server.py`):** Cuando lo ejecutas, inicia un servidor web en tu PC.
   *   Cuando accedes a la dirección IP de tu PC desde la tablet, la ruta `/` le dice a Flask que envíe el archivo `dashboard.html`.
   *   El código JavaScript dentro de `dashboard.html` hace peticiones a las rutas `/api/stats` y `/api/products`.
   *   El servidor Flask recibe estas peticiones, ejecuta las funciones de la base de datos correspondientes (`obtener_estadisticas`, `obtener_productos`), convierte los resultados a formato JSON y los envía de vuelta al navegador de la tablet.
   *   El JavaScript recibe estos datos JSON y los usa para rellenar las tarjetas de estadísticas y la tabla de productos.

### ¡A Probarlo!

1.  **Ejecuta el Servidor:** Abre una terminal, navega a la carpeta `Sistema` (`cd C:\Users\Administrator\Documents\Sistema`) y ejecuta el servidor:
   ```
   python server.py
   ```
   Verás un mensaje indicando que el servidor está corriendo en `http://0.0.0.0:5000/`.

2.  **Encuentra la IP de tu PC:**
   *   En la misma terminal, escribe `ipconfig` y presiona Enter.
   *   Busca una línea que diga "Dirección IPv4". Será un número como `192.168.1.10` (es un ejemplo, el tuyo será diferente).

3.  **Accede desde tu Tablet:**
   *   Asegúrate de que tu tablet esté conectada a la **misma red Wi-Fi** que tu PC.
   *   Abre el navegador web en la tablet.
   *   En la barra de direcciones, escribe la dirección IP de tu PC seguida de `:5000`. Por ejemplo: `http://192.168.1.10:5000`.
   *   ¡Deberías ver el panel de control con las estadísticas y la lista de productos en tiempo real!

Puedes tener la aplicación de escritorio (`main.py`) y el servidor (`server.py`) corriendo al mismo tiempo. Si agregas un producto o haces una venta en la aplicación de escritorio, solo necesitas recargar la página en tu tablet para ver los datos actualizados.

Hemos construido una base sólida para el acceso remoto. A partir de aquí, podemos añadir más funcionalidades a la interfaz web, como la capacidad de agregar o editar productos directamente desde la tablet.

<!--
[PROMPT_SUGGESTION]¿Cómo puedo agregar la capacidad de editar productos desde la tablet?[/PROMPT_SUGGESTION]
[PROMPT_SUGGESTION]Explícame con más detalle qué es una API y el formato JSON.[/PROMPT_SUGGESTION]

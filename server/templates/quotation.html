{% extends "layout.html" %}

{% block title %}Gestión de Cotizaciones{% endblock %}

{% block page_title %}<i class="bi bi-file-earmark-text"></i> Gestión de Cotizaciones{% endblock %}

{% block breadcrumb %}Gestión de Cotizaciones{% endblock %}

{% block content %}
<div class="container-fluid">
    <ul class="nav nav-tabs" id="quotationTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="new-quotation-tab" data-bs-toggle="tab" data-bs-target="#new-quotation-pane" type="button" role="tab" aria-controls="new-quotation-pane" aria-selected="true"><i class="bi bi-plus-circle"></i> Nueva Cotización</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-pane" type="button" role="tab" aria-controls="history-pane" aria-selected="false"><i class="bi bi-clock-history"></i> Historial</button>
        </li>
    </ul>

    <div class="tab-content" id="quotationTabsContent">
        <!-- Pestaña de Nueva Cotización -->
        <div class="tab-pane fade show active" id="new-quotation-pane" role="tabpanel" aria-labelledby="new-quotation-tab">
            <div class="row mt-3 g-4">
                <!-- Columna Izquierda: Búsqueda y Cliente -->
                <div class="col-lg-5">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-person-plus"></i> Cliente</h5>
                        </div>
                        <div class="card-body">
                            <div class="input-group">
                                <input type="text" id="client-search" class="form-control" placeholder="Buscar cliente por nombre o RNC...">
                                <span class="input-group-text"><i class="bi bi-person-lines-fill"></i></span>
                            </div>
                            <div id="client-results" class="search-results mt-1"></div>
                            <div id="selected-client" class="mt-2 d-none">
                                <div class="alert alert-info d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Cliente:</strong> <span id="client-name"></span>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger" id="clear-client" title="Quitar cliente"><i class="bi bi-x"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-search"></i> Agregar Productos</h5>
                        </div>
                        <div class="card-body">
                            <div class="input-group">
                                <input type="text" id="product-search" class="form-control" placeholder="Buscar productos...">
                                <button class="btn btn-outline-primary" id="scan-btn-quotation" type="button" data-bs-toggle="modal" data-bs-target="#scannerModalQuotation" title="Escanear con cámara">
                                    <i class="bi bi-upc-scan"></i>
                                </button>
                            </div>
                            <div id="product-results" class="search-results mt-1"></div>
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha: Resumen y Lista de Productos -->
                <div class="col-lg-7">
                    <div class="card shadow-lg">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-receipt"></i> Resumen de Cotización</h5>
                        </div>
                        <div class="card-body">
                            <!-- Lista de productos -->
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Producto</th>
                                            <th>Cant.</th>
                                            <th>Precio</th>
                                            <th>Subtotal</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="quotation-items">
                                        <!-- Productos se insertan aquí -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="empty-cart" class="text-center p-4 text-muted">
                                <i class="bi bi-cart-x display-4"></i>
                                <p class="mt-2">No hay productos en la cotización</p>
                            </div>

                            <!-- Resumen Financiero -->
                            <div class="mt-4 border-top pt-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <span id="subtotal-display">RD$ 0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>ITBIS (18%):</span>
                                    <span id="itbis-display">RD$ 0.00</span>
                                </div>
                                <div class="d-flex justify-content-between fs-4 fw-bold text-success">
                                    <span>Total:</span>
                                    <span id="total-display">RD$ 0.00</span>
                                </div>
                            </div>

                            <!-- Opciones y Acciones -->
                            <div class="mt-4 border-top pt-3">
                                <div class="row align-items-center">
                                    <div class="col-md-6 mb-3">
                                        <label for="validity-days" class="form-label">Validez de la Cotización</label>
                                        <select id="validity-days" class="form-select">
                                            <option value="15" selected>15 días</option>
                                            <option value="30">30 días</option>
                                            <option value="45">45 días</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-success" id="save-quotation-btn">
                                                <i class="bi bi-save"></i> Guardar Cotización
                                            </button>
                                            <button class="btn btn-outline-danger" id="clear-quotation-btn">
                                                <i class="bi bi-x-circle"></i> Limpiar Todo
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña de Historial -->
        <div class="tab-pane fade" id="history-pane" role="tabpanel" aria-labelledby="history-tab">
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card shadow-lg">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-clock-history"></i> Historial de Cotizaciones</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Fecha</th>
                                            <th>Cliente</th>
                                            <th>Total</th>
                                            <th>Estado</th>
                                            <th>Válida hasta</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="quotations-history">
                                        <!-- Cotizaciones se insertan aquí dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="empty-history" class="text-center p-4 text-muted">
                                <i class="bi bi-file-earmark-x display-4"></i>
                                <p class="mt-2">No hay cotizaciones guardadas</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para cantidad -->
<div class="modal fade" id="quantityModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cantidad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="number" class="form-control text-center" id="quantity-input" min="1" value="1">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirm-quantity">Agregar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal del Escáner para Cotizaciones -->
<div class="modal fade" id="scannerModalQuotation" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scannerModalLabel"><i class="bi bi-camera-video"></i> Escáner de Productos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted text-center">Apunte la cámara al código de barras del producto.</p>
        <div id="quotation-scanner-viewport" class="viewport mx-auto" style="max-width: 320px; min-height: 240px; position: relative; background: #000; border-radius: 8px; overflow: hidden;">
            <!-- QuaggaJS se adjuntará aquí -->
        </div>
        <div id="quotation-scanner-status" class="mt-2 text-center text-muted"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Cargar historial cuando se muestra la pestaña
    document.getElementById('history-tab').addEventListener('shown.bs.tab', function () {
        loadQuotationsHistory();

    });
    let quotationItems = [];
    let selectedClient = null;
    let selectedProductForQuantity = null;
    const ITBIS_RATE = 0.18;

    function formatCurrency(value) {
        return new Intl.NumberFormat('es-DO', { style: 'currency', currency: 'DOP' }).format(value);
    }

    function updateSummary() {
        const totalItems = quotationItems.reduce((sum, item) => sum + item.cantidad, 0);
        const subtotal = quotationItems.reduce((sum, item) => sum + (item.cantidad * item.precio), 0);
        const itbis = subtotal * ITBIS_RATE;
        const total = subtotal + itbis;

        document.getElementById('total-items').textContent = totalItems;
        document.getElementById('subtotal-display').textContent = formatCurrency(subtotal);
        document.getElementById('itbis-display').textContent = formatCurrency(itbis);
        document.getElementById('total-display').textContent = formatCurrency(total);

        document.getElementById('empty-cart').style.display = quotationItems.length === 0 ? 'block' : 'none';
    }

    function renderQuotationItems() {
        const tbody = document.getElementById('quotation-items');
        tbody.innerHTML = '';

        quotationItems.forEach((item, index) => {
            const subtotal = item.cantidad * item.precio;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${item.nombre}</strong></td>
                <td><input type="number" class="form-control form-control-sm text-center" value="${item.cantidad}" min="1" onchange="updateQuantity(${index}, this.value)"></td>
                <td>${formatCurrency(item.precio)}</td>
                <td>${formatCurrency(subtotal)}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removeItem(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });

        updateSummary();
    }

    function removeItem(index) {
        quotationItems.splice(index, 1);
        renderQuotationItems();
    }

    async function loadQuotationsHistory() {
        try {
            const response = await fetch('/api/quotations');
            const quotations = await response.json();

            const tbody = document.getElementById('quotations-history');
            tbody.innerHTML = '';

            if (quotations.length === 0) {
                document.getElementById('empty-history').style.display = 'block';
                return;
            }

            document.getElementById('empty-history').style.display = 'none';

            quotations.forEach(q => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${q.id}</td>
                    <td>${new Date(q.fecha).toLocaleDateString('es-DO')}</td>
                    <td>${q.cliente || 'Consumidor Final'}</td>
                    <td class="fw-bold">${formatCurrency(q.total || 0)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewQuotation(${q.id})">
                            <i class="bi bi-eye"></i> Ver
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="loadQuotationInPOS('${q.id}')" title="Cargar en Punto de Venta">
                            <i class="bi bi-box-arrow-up-right"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error al cargar historial:', error);
        }
    }

    function viewQuotation(quotationId) {
        window.open(`/api/quotation/generate_pdf/${quotationId}`, '_blank');
    }

    async function loadQuotationInPOS(quotationId) {
        if (!confirm('¿Desea cargar esta cotización en el Punto de Venta? Se limpiará cualquier venta en curso.')) {
            return;
        }

        try {
            const response = await fetch(`/api/quotation/details/${quotationId}`);
            const result = await response.json();

            if (result.success) {
                // Guardar los datos en sessionStorage para que la página del POS los lea
                sessionStorage.setItem('quotationToLoad', JSON.stringify(result.data));
                // Redirigir al POS
                window.location.href = "{{ url_for('pos_page') }}";
            } else {
                alert('Error al cargar los detalles de la cotización: ' + result.error);
            }
        } catch (error) {
            console.error('Error de red:', error);
            alert('Error de red al intentar cargar la cotización.');
        }
    }

    // Event listeners
    document.getElementById('product-search').addEventListener('keyup', async (e) => {
        const term = e.target.value;
        if (term.length < 3) {
            document.getElementById('product-results').innerHTML = '';
            return;
        }

        const response = await fetch('/api/search_products', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ term })
        });
        const data = await response.json();

        const resultsDiv = document.getElementById('product-results');
        resultsDiv.innerHTML = '';

        if (data.success && data.products.length > 0) {
            data.products.forEach(product => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <div>
                        <strong>${product.nombre}</strong><br>
                        <small class="text-muted">${formatCurrency(product.precio)}</small>
                    </div>
                    <span class="badge bg-primary">Stock: ${product.stock}</span>
                `;
                item.onclick = (e) => {
                    e.preventDefault();
                    selectedProductForQuantity = product;
                    document.getElementById('quantity-input').value = '1';
                    new bootstrap.Modal(document.getElementById('quantityModal')).show();
                    resultsDiv.innerHTML = '';
                    document.getElementById('product-search').value = '';
                };
                resultsDiv.appendChild(item);
            });
            resultsDiv.className = 'list-group position-absolute w-100 mt-1 shadow-sm';
        }
    });

    document.getElementById('confirm-quantity').addEventListener('click', () => {
        const quantity = parseInt(document.getElementById('quantity-input').value);
        if (quantity > 0 && selectedProductForQuantity) {
            // Verificar si el producto ya existe en la cotización
            const existingItem = quotationItems.find(item => item.id === selectedProductForQuantity.id);

            if (existingItem) {
                // Si existe, solo incrementar la cantidad
                existingItem.cantidad += quantity;
            } else {
                // Si no existe, agregarlo como nuevo
                quotationItems.push({
                    ...selectedProductForQuantity,
                    cantidad: quantity
                });
            }
            renderQuotationItems();
        }
        bootstrap.Modal.getInstance(document.getElementById('quantityModal')).hide();
    });

    document.getElementById('client-search').addEventListener('keyup', async (e) => {
        const term = e.target.value;
        if (term.length < 2) {
            document.getElementById('client-results').innerHTML = '';
            return;
        }

        const response = await fetch('/api/search_clients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ term })
        });
        const data = await response.json();

        const resultsDiv = document.getElementById('client-results');
        resultsDiv.innerHTML = '';

        if (data.success && data.clients.length > 0) {
            data.clients.forEach(client => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.innerHTML = `
                    <strong>${client.nombre}</strong><br>
                    <small class="text-muted">${client.rnc_cedula}</small>
                `;
                item.onclick = (e) => {
                    e.preventDefault();
                    selectedClient = client;
                    document.getElementById('client-name').textContent = client.nombre;
                    document.getElementById('selected-client').classList.remove('d-none');
                    document.getElementById('client-search').value = '';
                    resultsDiv.innerHTML = '';
                };
                resultsDiv.appendChild(item);
            });
            resultsDiv.className = 'list-group position-absolute w-100 mt-1 shadow-sm';
        }
    });

    document.getElementById('clear-client').addEventListener('click', () => {
        selectedClient = null;
        document.getElementById('selected-client').classList.add('d-none');
    });

    document.getElementById('save-quotation-btn').addEventListener('click', async () => {
        if (quotationItems.length === 0) {
            alert('Agregue productos a la cotización');
            return;
        }
        
        const validityDays = document.getElementById('validity-days').value;

        try {
            const response = await fetch('/api/quotation/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    items: quotationItems,
                    client_id: selectedClient ? selectedClient._id : null,
                    validez_dias: parseInt(validityDays)
                })
            });
            const result = await response.json();

            if (result.success) {
                alert(`Cotización guardada con ID: ${result.quotation_id}`);
                quotationItems = [];
                selectedClient = null;
                document.getElementById('selected-client').classList.add('d-none');
                renderQuotationItems();
                loadQuotationsHistory();
            } else {
                alert(`Error: ${result.error}`);
            }
        } catch (error) {
            alert('Error de conexión');
        }
    });

    document.getElementById('generate-pdf-btn').addEventListener('click', async () => {
        if (quotationItems.length === 0) {
            alert('Agregue productos a la cotización');
            return;
        }

        try {
            const response = await fetch('/api/generate_quotation_pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    items: quotationItems,
                    client: selectedClient ? { nombre: selectedClient.nombre } : { nombre: 'Consumidor Final' }
                })
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
            } else {
                const result = await response.json();
                alert(`Error: ${result.error}`);
            }
        } catch (error) {
            alert('Error de conexión');
        }
    });

    document.getElementById('clear-quotation-btn').addEventListener('click', () => {
        if (quotationItems.length > 0 && confirm('¿Está seguro de limpiar la cotización?')) {
            quotationItems = [];
            selectedClient = null;
            document.getElementById('selected-client').classList.add('d-none');
            renderQuotationItems();
        }
    });

    // Event listener para escaneo de código de barras
    let barcodeScanTimeout;

    document.getElementById('barcode-input').addEventListener('input', async (e) => {
        const input = e.target;
        const barcode = input.value.trim();

        // Limpiar timeout anterior
        if (barcodeScanTimeout) {
            clearTimeout(barcodeScanTimeout);
        }

        // Si no hay caracteres, salir
        if (!barcode) return;

        // Si el código es demasiado corto, esperar más input
        if (barcode.length < 8) return;

        // Si el código parece completo (8-13 caracteres, solo dígitos), procesar automáticamente
        if (barcode.length >= 8 && barcode.length <= 13 && /^[0-9]+$/.test(barcode)) {
            // Procesar inmediatamente si parece un código de barras válido
            processBarcodeScan(barcode);
        } else if (barcode.length > 13) {
            // Si es muy largo, podría ser ingreso manual o código largo, procesar con delay
            barcodeScanTimeout = setTimeout(() => {
                if (input.value.trim() === barcode) {
                    processBarcodeScan(barcode);
                }
            }, 300);
        }
    });

    // También mantener el método manual con Enter por si acaso
    document.getElementById('barcode-input').addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const barcode = e.target.value.trim();
            if (barcode) {
                processBarcodeScan(barcode);
            }
        }
    });

    async function processBarcodeScan(barcode) {
        const input = document.getElementById('barcode-input');

        // Limpiar timeout si existe
        if (barcodeScanTimeout) {
            clearTimeout(barcodeScanTimeout);
        }

        // Limpiar el campo
        input.value = '';
        input.focus();

        try {
            const response = await fetch('/api/scan_product', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ barcode: barcode })
            });

            const result = await response.json();

            if (result.success) {
                selectedProductForQuantity = result.product;
                document.getElementById('quantity-input').value = '1';
                new bootstrap.Modal(document.getElementById('quantityModal')).show();

                // Reproducir beep de éxito si está disponible
                if ('Audio' in window) {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);

                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                    } catch (e) {
                        console.log('Beep no disponible');
                    }
                }
            } else {
                // Reproducir beep de error
                if ('Audio' in window) {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                    } catch (e) {
                        console.log('Beep de error no disponible');
                    }
                }

                alert(`Producto no encontrado: ${result.error}`);
            }
        } catch (error) {
            alert('Error de conexión al buscar el producto.');
        }
    }

    // Inicialización
    renderQuotationItems();
    loadQuotationsHistory();

    // --- LÓGICA DEL ESCÁNER EN MODAL ---
    const scannerModalQuotation = document.getElementById('scannerModalQuotation');
    if (scannerModalQuotation) {
        const quotationScanner = (function() {
            let isScannerActive = false;
            let lastScannedCode = null;
            const viewport = document.getElementById('quotation-scanner-viewport');
            const statusEl = document.getElementById('quotation-scanner-status');

            function updateStatus(message, type = 'secondary') {
                if (statusEl) statusEl.innerHTML = `<i class="bi bi-circle-fill text-${type}"></i> ${message}`;
            }

            const onDetected = (result) => {
                const code = result.codeResult.code;
                if (code === lastScannedCode) return;

                lastScannedCode = code;
                updateStatus('Código detectado, procesando...', 'info');
                processBarcodeScan(code); // Reutilizamos la función principal

                // Cerrar modal y resetear después de un escaneo exitoso
                setTimeout(() => {
                    const modalInstance = bootstrap.Modal.getInstance(scannerModalQuotation);
                    if (modalInstance) modalInstance.hide();
                }, 500);

                setTimeout(() => { lastScannedCode = null; }, 1500);
            };

            function init() {
                if (isScannerActive) return;
                updateStatus('Iniciando cámara...', 'warning');
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: viewport,
                        constraints: { width: { min: 320 }, height: { min: 240 }, facingMode: "environment" },
                    },
                    decoder: { readers: ["ean_reader", "code_128_reader", "upc_reader"] },
                    locate: true,
                }, function(err) {
                    if (err) {
                        console.error("Error Quagga:", err);
                        updateStatus('Error al iniciar cámara', 'danger');
                        return;
                    }
                    Quagga.start();
                    isScannerActive = true;
                    updateStatus('Escáner activo', 'primary');
                });
                Quagga.onDetected(onDetected);
            }

            function stop() {
                if (isScannerActive) {
                    Quagga.offDetected(onDetected);
                    Quagga.stop();
                    isScannerActive = false;
                    updateStatus('Escáner detenido', 'secondary');
                }
            }

            return { init, stop };
        })();

        scannerModalQuotation.addEventListener('shown.bs.modal', () => {
            quotationScanner.init();
        });

        scannerModalQuotation.addEventListener('hide.bs.modal', () => {
            quotationScanner.stop();
        });
    }
</script>
{% endblock %}

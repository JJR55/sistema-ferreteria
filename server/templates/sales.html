{% extends "layout.html" %}

{% block title %}POS - Punto de Venta{% endblock %}

{% block page_title %} Punto de Venta{%ntas endblock %}

{% block breadcrumb %}POS / Ventas{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row g-3">
        <!-- PANEL DE PRODUCTOS -->
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-box-seam-fill"></i> Cat谩logo de Productos</h5>
                    <div class="d-flex gap-2">
                        <input type="text" id="product-search" class="form-control form-control-sm" placeholder="Buscar producto..." style="width: 200px;">
                        <button class="btn btn-light btn-sm" onclick="openBarcodeScanner()" title="Escanear C贸digo de Barras">
                            <i class="bi bi-upc-scan"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="products-grid" class="row g-3 p-3">
                        <!-- Productos se cargar谩n aqu铆 v铆a JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- CARRITO DE COMPRA -->
        <div class="col-lg-4">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-cart-check-fill"></i> Carrito de Compra</h5>
                </div>
                <div class="card-body">
                    <!-- Lista de items -->
                    <div id="cart-items" class="cart-items mb-3" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-cart-x display-4"></i>
                            <p>Carrito vac铆o</p>
                        </div>
                    </div>

                    <!-- Totales -->
                    <div class="totals bg-light p-3 rounded">
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label mb-1">Subtotal</label>
                                <input type="text" id="subtotal" class="form-control form-control-sm" readonly value="RD$ 0.00">
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-1">ITBIS (18%)</label>
                                <input type="text" id="itbis-total" class="form-control form-control-sm" readonly value="RD$ 0.00">
                            </div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label mb-1">Descuento</label>
                                <input type="number" id="discount" class="form-control form-control-sm" step="0.01" min="0" placeholder="0.00" onchange="updateTotals()">
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-1">M茅todo de Pago</label>
                                <select id="payment-method" class="form-select form-select-sm">
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Tarjeta">Tarjeta</option>
                                    <option value="Cr茅dito">Cr茅dito</option>
                                    <option value="Transferencia">Transferencia</option>
                                </select>
                            </div>
                        </div>
                        <hr>
                        <div class="text-center">
                            <h3 class="text-primary mb-2" id="total-amount">RD$ 0.00</h3>
                            <small class="text-muted">Total a Pagar</small>
                        </div>
                    </div>

                    <!-- Botones de acci贸n -->
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-success btn-lg" id="checkout-btn" disabled>
                            <i class="bi bi-check-circle-fill"></i> Procesar Venta
                        </button>
                        <button class="btn btn-outline-danger" id="clear-cart-btn">
                            <i class="bi bi-cart-x"></i> Limpiar Carrito
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Punto de Venta Completa -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="checkoutModalLabel"><i class="bi bi-check-circle-fill"></i> Finalizar Venta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-6">
                        <h6 class="mb-3">Resumen de Compra</h6>
                        <div id="checkout-items" class="border p-3 mb-3 bg-light" style="max-height: 200px; overflow-y: auto;"></div>
                        <div class="border p-3 bg-primary text-white rounded">
                            <div class="d-flex justify-content-between"><strong>Total:</strong><strong id="checkout-total">RD$ 0.00</strong></div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <h6 class="mb-3">Informaci贸n del Cliente</h6>
                        <div class="mb-3">
                            <label for="client-search" class="form-label">Buscar Cliente (Opcional)</label>
                            <input type="text" id="client-search" class="form-control" placeholder="Nombre, RNC o C茅dula">
                            <div id="client-results" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Monto Recibido</label>
                            <input type="number" id="amount-received" class="form-control" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cambio</label>
                            <input type="text" id="change-amount" class="form-control bg-warning text-dark" readonly>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="no-receipt-checkbox">
                                <label class="form-check-label" for="no-receipt-checkbox">
                                    Cliente no requiere factura/ticket
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="confirm-sale-btn">
                    <i class="bi bi-receipt"></i> Procesar Venta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Esc谩ner de C贸digo de Barras -->
<div class="modal fade" id="barcodeModal" tabindex="-1" aria-labelledby="barcodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="barcodeModalLabel"><i class="bi bi-upc-scan"></i> Escanear C贸digo de Barras</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <label for="barcode-input" class="form-label">C贸digo de Barras</label>
                    <input type="text" id="barcode-input" class="form-control text-center" placeholder="Ingrese o escanee el c贸digo" autofocus>
                </div>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" id="scan-barcode-btn">
                        <i class="bi bi-search"></i> Buscar Producto
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

<style>
/* === PRODUCTOS GRID === */
#products-grid {
    margin: 0 !important;
}

.product-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    margin-bottom: 8px;
}

.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-color: #007bff;
}

.product-card.out-of-stock {
    opacity: 0.6;
    background: #f8f9fa;
}

.product-name {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 4px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.product-price {
    font-weight: 700;
    color: #28a745;
    font-size: 1.1rem;
}

.product-stock {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 4px;
}

/* === CARRITO === */
.cart-items {
    min-height: 150px;
}

.cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #dee2e6;
}

.cart-item:last-child {
    border-bottom: none;
}

.cart-item-info {
    flex-grow: 1;
    margin-right: 10px;
}

.cart-item-name {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 2px;
}

.cart-item-price {
    font-size: 0.8rem;
    color: #6c757d;
}

.cart-item-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.quantity-controls {
    display: flex;
    align-items: center;
    gap: 4px;
}

.quantity-controls button {
    width: 24px;
    height: 24px;
    padding: 0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
}

/* === TOTALS === */
.totals {
    border: 2px solid #007bff;
    border-radius: 8px;
}

.totals h3 {
    font-size: 1.8rem;
    margin: 0;
}

/* === MODAL CHECKOUT === */
.checkout-item {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    border-bottom: 1px dashed #dee2e6;
}

.checkout-item:last-child {
    border-bottom: none;
}

/* === RESPONSIVE === */
@media (max-width: 768px) {
    #products-grid .col-xl-3,
    #products-grid .col-lg-4,
    #products-grid .col-md-6 {
        padding: 4px !important;
    }

    .product-card {
        padding: 8px;
    }

    .card-body {
        padding: 15px;
    }
}
</style>

{% block extra_scripts %}
<script>
const currencyFormatter = new Intl.NumberFormat('es-DO', { style: 'currency', currency: 'DOP' });
let allProducts = [];
let cart = [];
const checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));

function formatCurrency(amount) {
    return currencyFormatter.format(amount);
}

function loadProducts() {
    fetch('/api/products')
        .then(response => response.json())
        .then(products => {
            allProducts = products;
            renderProducts(products);
        })
        .catch(error => console.error('Error cargando productos:', error));
}

function renderProducts(products) {
    const grid = document.getElementById('products-grid');
    grid.innerHTML = '';

    products.forEach(product => {
        const stock = product.stock || 0;
        const isOutOfStock = stock <= 0;
        const stockClass = isOutOfStock ? 'text-danger' : 'text-success';

        const card = document.createElement('div');
        card.className = `col-xl-3 col-lg-4 col-md-6 ${isOutOfStock ? 'out-of-stock' : ''}`;
        card.innerHTML = `
            <div class="product-card" onclick="addToCart('${product.id}')">
                <div class="product-name">${product.nombre || 'Sin nombre'}</div>
                <div class="product-price">${formatCurrency(product.precio || 0)}</div>
                <div class="product-stock ${stockClass}">
                    <i class="bi bi-box-seam"></i> ${stock} ${product.unidad_medida || 'unidades'}
                </div>
            </div>
        `;
        grid.appendChild(card);
    });
}

function addToCart(productId) {
    const product = allProducts.find(p => p.id == productId);
    if (!product) return;

    const stock = product.stock || 0;
    if (stock <= 0) {
        alert('Producto sin stock disponible');
        return;
    }

    // Buscar si ya existe en el carrito
    const existingItem = cart.find(item => item.id == productId);

    if (existingItem) {
        if (existingItem.cantidad >= stock) {
            alert('No hay suficiente stock disponible');
            return;
        }
        existingItem.cantidad++;
    } else {
        cart.push({
            id: product.id,
            nombre: product.nombre,
            precio: product.precio || 0,
            costo: product.costo || 0,
            cantidad: 1,
            stock: stock
        });
    }

    updateCart();
    updateTotals();

    // Animaci贸n de 茅xito
    showSuccessToast(`${product.nombre || 'Producto'} agregado al carrito`);
}

function updateCart() {
    const cartItems = document.getElementById('cart-items');
    const checkoutBtn = document.getElementById('checkout-btn');

    if (cart.length === 0) {
        cartItems.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-cart-x display-4"></i>
                <p>Carrito vac铆o</p>
            </div>
        `;
        checkoutBtn.disabled = true;
        return;
    }

    checkoutBtn.disabled = false;
    cartItems.innerHTML = cart.map(item => `
        <div class="cart-item">
            <div class="cart-item-info">
                <div class="cart-item-name">${item.nombre || 'Producto'}</div>
                <div class="cart-item-price">${formatCurrency(item.precio)} x ${item.cantidad}</div>
            </div>
            <div class="cart-item-controls">
                <div class="quantity-controls">
                    <button class="btn btn-sm btn-outline-secondary" onclick="changeQuantity('${item.id}', -1)">
                        <i class="bi bi-dash"></i>
                    </button>
                    <span class="mx-2">${item.cantidad}</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="changeQuantity('${item.id}', 1)">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>
                <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeFromCart('${item.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        <div class="cart-item">
            <small class="text-muted">Subtotal: ${formatCurrency(item.precio * item.cantidad)}</small>
        </div>
    `).join('');
}

function changeQuantity(productId, delta) {
    const item = cart.find(i => i.id == productId);
    if (!item) return;

    const newQuantity = item.cantidad + delta;

    if (newQuantity <= 0) {
        removeFromCart(productId);
        return;
    }

    if (newQuantity > item.stock) {
        alert('No hay suficiente stock disponible');
        return;
    }

    item.cantidad = newQuantity;
    updateCart();
    updateTotals();
}

function removeFromCart(productId) {
    cart = cart.filter(item => item.id != productId);
    updateCart();
    updateTotals();
}

function updateTotals() {
    const discount = parseFloat(document.getElementById('discount').value) || 0;

    const subtotal = cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    const subtotalDescontado = subtotal - discount;
    const itbisRate = 0.18;
    const itbis = subtotalDescontado * itbisRate;
    const total = subtotalDescontado + itbis;

    document.getElementById('subtotal').value = formatCurrency(subtotal);
    document.getElementById('itbis-total').value = formatCurrency(itbis);
    document.getElementById('total-amount').textContent = formatCurrency(total);

    return { subtotal, itbis, total, discount };
}

function clearCart() {
    if (cart.length === 0) return;

    if (confirm('驴Est谩 seguro de que desea vaciar el carrito?')) {
        cart = [];
        updateCart();
        updateTotals();
        document.getElementById('discount').value = '';
        showInfoToast('Carrito vaciado');
    }
}

// Funci贸n para mostrar el modal de checkout
document.getElementById('checkout-btn').addEventListener('click', () => {
    showCheckout();
});

function showCheckout() {
    const checkoutItems = document.getElementById('checkout-items');
    const totals = updateTotals();

    checkoutItems.innerHTML = cart.map(item => `
        <div class="checkout-item">
            <span>${item.nombre} x ${item.cantidad}</span>
            <strong>${formatCurrency(item.precio * item.cantidad)}</strong>
        </div>
    `).join('');

    document.getElementById('checkout-total').textContent = formatCurrency(totals.total);
    checkoutModal.show();
}

// Filtro de b煤squeda de productos
document.getElementById('product-search').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const filtered = allProducts.filter(product =>
        product.nombre.toLowerCase().includes(searchTerm) ||
        (product.codigo_barras && product.codigo_barras.toLowerCase().includes(searchTerm))
    );
    renderProducts(filtered);
});

// Calcular cambio autom谩ticamente
document.getElementById('amount-received').addEventListener('input', function() {
    const received = parseFloat(this.value) || 0;
    const totals = updateTotals();
    const change = received - totals.total;
    document.getElementById('change-amount').value = change >= 0 ? formatCurrency(change) : 'RD$ 0.00';
});

// Abir Modal de Esc谩ner
function openBarcodeScanner() {
    const barcodeModal = new bootstrap.Modal(document.getElementById('barcodeModal'));
    document.getElementById('barcode-input').value = '';
    document.getElementById('barcode-input').focus();
    barcodeModal.show();
}

// Manejo del modal de esc谩ner
document.getElementById('scan-barcode-btn').addEventListener('click', () => {
    const code = document.getElementById('barcode-input').value.trim();
    if (!code) {
        alert('Por favor ingrese un c贸digo de barras');
        return;
    }

    fetch('/api/scan_product', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ barcode: code })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            addToCart(result.product.id);
            bootstrap.Modal.getInstance(document.getElementById('barcodeModal')).hide();
            showSuccessToast(`Producto "${result.product.nombre}" agregado`);
        } else {
            alert('Producto no encontrado con ese c贸digo de barras');
        }
    })
    .catch(error => {
        alert('Error al buscar el producto');
    });
});

// Permitir Enter en el campo de c贸digo de barras
document.getElementById('barcode-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('scan-barcode-btn').click();
    }
});

// Confirmar venta
document.getElementById('confirm-sale-btn').addEventListener('click', async () => {
    const paymentMethod = document.getElementById('payment-method').value;
    const totals = updateTotals();
    const noReceipt = document.getElementById('no-receipt-checkbox').checked;

    const saleData = {
        items: cart.map(item => ({
            id: item.id,
            cantidad: item.cantidad,
            precio: item.precio,
            costo: item.costo
        })),
        total: totals.total,
        payment_method: paymentMethod,
        discount: totals.discount,
        no_receipt: noReceipt
    };

    try {
        const response = await fetch('/api/pos/register_sale', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(saleData)
        });

        const result = await response.json();
        if (result.success) {
            const saleMessage = noReceipt
                ? `Venta ${result.sale_id} registrada (sin ticket solicitado)`
                : `Venta ${result.sale_id} registrada exitosamente`;

            if (!noReceipt) {
                // Abrir nueva ventana para imprimir ticket
                const ticketUrl = `/api/pos/print_ticket/${result.sale_id}`;
                window.open(ticketUrl, '_blank', 'width=400,height=600,scrollbars=yes,resizable=yes');
            }

            showSuccessToast(saleMessage);
            checkoutModal.hide();
            clearCart();
            loadProducts(); // Actualizar stock
        } else {
            alert(`Error: ${result.error}`);
        }
    } catch (error) {
        alert('Error de conexi贸n al registrar la venta');
    }
});

// Funci贸n scanProduct (mantener compatibilidad con posibles llamadas)
function scanProduct() {
    openBarcodeScanner();
}

// Toasts de notificaci贸n
function showSuccessToast(message) {
    // Crear toast simple (puedes usar Bootstrap Toast si prefieres)
    const toast = document.createElement('div');
    toast.className = 'alert alert-success alert-dismissible position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;

    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function showInfoToast(message) {
    const toast = document.createElement('div');
    toast.className = 'alert alert-info alert-dismissible position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;

    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Limpieza del carrito
document.getElementById('clear-cart-btn').addEventListener('click', clearCart);

// Inicializaci贸n
document.addEventListener('DOMContentLoaded', () => {
    loadProducts();
    updateCart();
    updateTotals();
});
</script>
{% endblock %}

{% extends "layout.html" %}

{% block title %}Reportes de Ventas - Sistema Ferreter√≠a{% endblock %}

{% block page_title %}<i class="bi bi-graph-up"></i> Reportes de Ventas{% endblock %}

{% block breadcrumb %}Reportes y Estad√≠sticas{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- HEADER -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="header-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">üîç Reportes de Ventas Detallados</h4>
                        <p class="mb-0 text-light opacity-75">An√°lisis diario, semanal y mensual de tus ventas</p>
                    </div>
                    <div class="current-date-display">
                        <i class="bi bi-calendar-event"></i>
                        <span id="current-date-display">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTROLES DE PERIODO -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label fw-semibold"><i class="bi bi-calendar-range"></i> Tipo de Reporte</label>
                            <select class="form-select" id="report-type-selector">
                                <option value="daily">üìÖ Reporte Diario</option>
                                <option value="weekly">üìä Reporte Semanal</option>
                                <option value="monthly">üìà Reporte Mensual</option>
                            </select>
                        </div>

                        <div class="col-md-3" id="date-selector">
                            <label class="form-label fw-semibold"><i class="bi bi-calendar-date"></i> Fecha</label>
                            <input type="date" class="form-control" id="selected-date" value="">
                        </div>

                        <div class="col-md-3" id="month-selector" style="display: none;">
                            <label class="form-label fw-semibold"><i class="bi bi-calendar-month"></i> Mes</label>
                            <select class="form-select" id="selected-month">
                                <option value="01">Enero</option>
                                <option value="02">Febrero</option>
                                <option value="03">Marzo</option>
                                <option value="04">Abril</option>
                                <option value="05">Mayo</option>
                                <option value="06">Junio</option>
                                <option value="07">Julio</option>
                                <option value="08">Agosto</option>
                                <option value="09">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label fw-semibold"><i class="bi bi-search"></i> Acciones</label>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary flex-fill" id="generate-report-btn">
                                    <i class="bi bi-play-circle"></i> Generar
                                </button>
                                <button class="btn btn-outline-success" id="export-pdf-btn" disabled>
                                    <i class="bi bi-file-earmark-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOADING SPINNER -->
    <div class="row mb-4" id="loading-spinner" style="display: none;">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2 text-muted">Generando reporte...</p>
        </div>
    </div>

    <!-- RESULTADOS DEL REPORTE -->
    <div id="report-results" style="display: none;">
        <!-- HEADER DEL REPORTE -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="report-header-card">
                    <div class="row g-4">
                        <!-- INFO GENERAL -->
                        <div class="col-lg-6">
                            <div class="info-section">
                                <h5 class="mb-3"><i class="bi bi-info-circle-fill"></i> Informaci√≥n del Periodo</h5>
                                <div class="report-info-grid">
                                    <div class="info-item">
                                        <div class="info-label">Periodo Reportado</div>
                                        <div class="info-value" id="report-period">Cargando...</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Fecha de Generaci√≥n</div>
                                        <div class="info-value" id="report-generation-date">Cargando...</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Tipo de Reporte</div>
                                        <div class="info-value" id="report-type">Cargando...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- KPIs RESUMEN -->
                        <div class="col-lg-6">
                            <div class="kpi-summary-grid">
                                <div class="kpi-summary-item primary">
                                    <div class="kpi-icon">
                                        <i class="bi bi-cash-stack"></i>
                                    </div>
                                    <div class="kpi-content">
                                        <div class="kpi-value" id="total-sales">RD$0.00</div>
                                        <div class="kpi-label">Total Ventas</div>
                                    </div>
                                </div>

                                <div class="kpi-summary-item success">
                                    <div class="kpi-icon">
                                        <i class="bi bi-receipt"></i>
                                    </div>
                                    <div class="kpi-content">
                                        <div class="kpi-value" id="total-transactions">0</div>
                                        <div class="kpi-label">Transacciones</div>
                                    </div>
                                </div>

                                <div class="kpi-summary-item info">
                                    <div class="kpi-icon">
                                        <i class="bi bi-coin"></i>
                                    </div>
                                    <div class="kpi-content">
                                        <div class="kpi-value" id="avg-sale">RD$0.00</div>
                                        <div class="kpi-label">Venta Promedio</div>
                                    </div>
                                </div>

                                <div class="kpi-summary-item warning">
                                    <div class="kpi-icon">
                                        <i class="bi bi-percent"></i>
                                    </div>
                                    <div class="kpi-content">
                                        <div class="kpi-value" id="profit-margin">0%</div>
                                        <div class="kpi-label">Margen</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GR√ÅFICO Y TABLA -->
        <div class="row mb-4">
            <!-- Gr√°fico de Ventas -->
            <div class="col-lg-8 mb-4">
                <div class="card shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-bar-chart-line"></i> Tendencia de Ventas</h5>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="chartType" id="barChart" autocomplete="off" checked>
                            <label class="btn btn-outline-secondary btn-sm" for="barChart">Barras</label>

                            <input type="radio" class="btn-check" name="chartType" id="lineChart" autocomplete="off">
                            <label class="btn btn-outline-secondary btn-sm" for="lineChart">L√≠nea</label>

                            <input type="radio" class="btn-check" name="chartType" id="areaChart" autocomplete="off">
                            <label class="btn btn-outline-secondary btn-sm" for="areaChart">√Årea</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="salesTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Breakdown -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Desglose</h5>
                    </div>
                    <div class="card-body">
                        <div class="breakdown-list">
                            <div class="breakdown-item">
                                <div class="breakdown-label">Efectivo</div>
                                <div class="breakdown-value" id="cash-sales">RD$0.00</div>
                                <div class="breakdown-percentage" id="cash-percentage">0%</div>
                            </div>
                            <div class="breakdown-item">
                                <div class="breakdown-label">Tarjeta</div>
                                <div class="breakdown-value" id="card-sales">RD$0.00</div>
                                <div class="breakdown-percentage" id="card-percentage">0%</div>
                            </div>
                            <div class="breakdown-item">
                                <div class="breakdown-label">Cr√©dito</div>
                                <div class="breakdown-value" id="credit-sales">RD$0.00</div>
                                <div class="breakdown-percentage" id="credit-percentage">0%</div>
                            </div>
                            <div class="breakdown-item">
                                <div class="breakdown-label">Transferencia</div>
                                <div class="breakdown-value" id="transfer-sales">RD$0.00</div>
                                <div class="breakdown-percentage" id="transfer-percentage">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DETALLE DE VENTAS -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-table"></i> Detalle de Ventas</h5>
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary btn-sm" id="sort-date-btn">üìÖ Fecha</button>
                            <button class="btn btn-outline-secondary btn-sm" id="sort-amount-btn">üí∞ Monto</button>
                            <button class="btn btn-outline-secondary btn-sm active" id="sort-time-btn">‚è∞ Hora</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Hora</th>
                                        <th>Factura</th>
                                        <th>Pago</th>
                                        <th>Subtotal</th>
                                        <th>ITBIS</th>
                                        <th>Descuento</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="sales-detail-table-body">
                                    <!-- Filas se insertar√°n aqu√≠ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <div class="text-muted small">
                            <i class="bi bi-info-circle"></i>
                            <span>Mostrando registros del periodo seleccionado. Para ver m√°s detalles, haga clic en cualquier fila.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PRODUCTOS M√ÅS VENDIDOS -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-trophy"></i> Productos M√°s Vendidos (Top 10)</h5>
                    </div>
                    <div class="card-body">
                        <div class="top-products-grid" id="top-products-grid">
                            <!-- Productos se insertar√°n aqu√≠ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MENSAJE CUANDO NO HAY DATOS -->
    <div class="row" id="no-data-message" style="display: none;">
        <div class="col-12 text-center py-5">
            <div class="empty-state">
                <i class="bi bi-bar-chart-line-fill" style="font-size: 4rem; color: #6c757d; opacity: 0.3;"></i>
                <h4 class="mt-3">No hay datos disponibles</h4>
                <p class="text-muted">No se encontraron ventas para el periodo seleccionado.</p>
                <button class="btn btn-primary" onclick="resetFilters()">
                    <i class="bi bi-arrow-counterclockwise"></i> Cambiar Periodo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Estilos CSS para la p√°gina de reportes -->
<style>
/* === HEADER CARD === */
.header-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.current-date-display {
    background: rgba(255,255,255,0.2);
    padding: 10px 15px;
    border-radius: 10px;
    font-weight: 500;
}

/* === REPORT HEADER CARD === */
.report-header-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(245, 87, 108, 0.3);
}

.info-section h5 {
    color: rgba(255,255,255,0.9);
    margin-bottom: 20px;
}

.report-info-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
}

.info-item {
    background: rgba(255,255,255,0.15);
    padding: 15px;
    border-radius: 10px;
    backdrop-filter: blur(10px);
}

.info-label {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-value {
    font-weight: 600;
    font-size: 1.1rem;
}

/* === KPI SUMMARY GRID === */
.kpi-summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.kpi-summary-item {
    background: rgba(255,255,255,0.95);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-left: 4px solid;
}

.kpi-summary-item.primary { border-left-color: #007bff; }
.kpi-summary-item.success { border-left-color: #28a745; }
.kpi-summary-item.info { border-left-color: #17a2b8; }
.kpi-summary-item.warning { border-left-color: #ffc107; color: #000 !important; }

.kpi-summary-item .kpi-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: RGBA(var(--bs-primary-rgb), 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-right: 15px;
    color: var(--bs-primary);
}

.kpi-alue {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    line-height: 1;
}

.kpi-summary-item.primary .kpi-icon { background: rgba(0,123,255,0.1); color: #007bff; }
.kpi-summary-item.success .kpi-icon { background: rgba(40,167,69,0.1); color: #28a745; }
.kpi-summary-item.info .kpi-icon { background: rgba(23,162,184,0.1); color: #17a2b8; }
.kpi-summary-item.warning .kpi-icon { background: rgba(255,193,7,0.1); color: #ffc107; }

/* === BREAKDOWN LIST === */
.breakdown-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.breakdown-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 3px solid #007bff;
}

.breakdown-label {
    font-weight: 500;
    color: #333;
}

.breakdown-value {
    font-weight: 600;
    color: #007bff;
    font-size: 0.95rem;
}

.breakdown-percentage {
    color: #6c757d;
    font-size: 0.85rem;
    background: #e9ecef;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
}

/* === TOP PRODUCTS GRID === */
.top-products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
}

.top-product-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.top-product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.top-product-rank {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: linear-gradient(45deg, #ffd700, #ffed4e);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #8b5a00;
    font-weight: bold;
    font-size: 0.9rem;
    margin-right: 15px;
    flex-shrink: 0;
}

.top-product-info h6 {
    margin: 0;
    font-weight: 600;
    font-size: 0.95rem;
    line-height: 1.3;
    color: #333;
}

.top-product-quantity {
    color: #007bff;
    font-weight: 600;
    font-size: 0.9rem;
    margin-top: 5px;
}

/* === EMPTY STATE === */
.empty-state {
    padding: 3rem 2rem;
    background: #f8f9fa;
    border-radius: 15px;
    border: 1px dashed #dee2e6;
}

.empty-state i {
    display: block;
    margin-bottom: 1rem;
}

/* === CHART CONTAINER === */
.chart-container {
    position: relative;
    height: 300px;
}

/* === ANIMATIONS === */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.report-results {
    animation: fadeIn 0.5s ease-out;
}

/* === RESPONSIVE === */
@media (max-width: 768px) {
    .kpi-summary-grid {
        grid-template-columns: 1fr;
    }

    .header-card .d-flex {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }

    .top-products-grid {
        grid-template-columns: 1fr;
    }

    .report-header-card .row > div {
        margin-bottom: 2rem;
    }

    .report-header-card .row > div:last-child {
        margin-bottom: 0;
    }
}

/* === LOADING SPINNER ENHANCEMENT === */
.spinner-border {
    animation: spinner-border 0.75s linear infinite;
}

/* === HIGHLIGHTS === */
.highlight-up {
    color: #28a745 !important;
    font-weight: 600;
}

.highlight-down {
    color: #dc3545 !important;
    font-weight: 600;
}

.highlight-neutral {
    color: #6c757d !important;
}

/* === SORT BUTTONS === */
.btn-group .btn.active {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>
<script>
    const currencyFormatter = new Intl.NumberFormat('es-DO', { style: 'currency', currency: 'DOP' });
    let salesTrendChart = null;
    let currentReportData = null;

    // Configure window.onload
    window.addEventListener('load', () => {
        initializePage();
    });

    function initializePage() {
        updateCurrentDateDisplay();
        setupTypeSelector();
        setupChartButtons();
        setDefaultDate();
    }

    function updateCurrentDateDisplay() {
        const now = new Date();
        const options = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        document.getElementById('current-date-display').textContent =
            now.toLocaleDateString('es-DO', options);
    }

    function setupTypeSelector() {
        const selector = document.getElementById('report-type-selector');
        const dateSelector = document.getElementById('date-selector');
        const monthSelector = document.getElementById('month-selector');

        selector.addEventListener('change', () => {
            const selectedType = selector.value;

            if (selectedType === 'monthly') {
                dateSelector.style.display = 'none';
                monthSelector.style.display = 'block';
                setDefaultMonth();
            } else {
                dateSelector.style.display = 'block';
                monthSelector.style.display = 'none';
                setDefaultDate();
            }
        });
    }

    function setupChartButtons() {
        const chartTypeRadios = document.querySelectorAll('input[name="chartType"]');

        chartTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (salesTrendChart && e.target.checked) {
                    changeChartType(e.target.id.replace('Chart', ''));
                }
            });
        });
    }

    function changeChartType(type) {
        if (!salesTrendChart) return;

        let chartType = 'bar';

        switch(type) {
            case 'bar':
                chartType = 'bar';
                break;
            case 'line':
                chartType = 'line';
                break;
            case 'area':
                chartType = {
                    type: 'line',
                    options: {
                        elements: {
                            line: {
                                fill: true,
                                backgroundColor: 'rgba(52, 132, 240, 0.2)'
                            }
                        }
                    }
                };
                break;
        }

        salesTrendChart.config.type = chartType;
        salesTrendChart.update();
    }

    function setDefaultDate() {
        const dateInput = document.getElementById('selected-date');
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }

    function setDefaultMonth() {
        const monthSelector = document.getElementById('selected-month');
        const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
        monthSelector.value = currentMonth;
    }

    function getReportParameters() {
        const reportType = document.getElementById('report-type-selector').value;

        let params = { type: reportType };

        if (reportType === 'monthly') {
            const selectedMonth = document.getElementById('selected-month').value;
            const currentYear = new Date().getFullYear();
            params.date = `${currentYear}-${selectedMonth}`;
        } else {
            params.date = document.getElementById('selected-date').value;
        }

        return params;
    }

    // Generate Report Button
    document.getElementById('generate-report-btn').addEventListener('click', () => {
        generateReport();
    });

    async function generateReport() {
        try {
            document.getElementById('loading-spinner').style.display = 'block';
            document.getElementById('report-results').style.display = 'none';
            document.getElementById('no-data-message').style.display = 'none';

            const params = getReportParameters();

            const response = await fetch(`/api/reports/sales/${params.type}?date=${params.date}`);
            const data = await response.json();

            if (data.success && data.data) {
                currentReportData = data.data;
                displayReportResults(data.data, params);
                document.getElementById('export-pdf-btn').disabled = false;
            } else {
                showNoDataMessage();
                document.getElementById('export-pdf-btn').disabled = true;
            }

        } catch (error) {
            console.error('Error generating report:', error);
            alert('Error al generar el reporte. Int√©ntalo de nuevo.');
        } finally {
            document.getElementById('loading-spinner').style.display = 'none';
        }
    }

    function displayReportResults(data, params) {
        // Update report header info
        updateReportHeader(data, params);

        // Update KPIs
        updateKPIs(data);

        // Create charts
        createSalesTrendChart(data);

        // Update breakdown
        updateSalesBreakdown(data);

        // Update sales detail table
        updateSalesDetailTable(data);

        // Update top products
        updateTopProducts(data);

        document.getElementById('report-results').style.display = 'block';
        document.getElementById('no-data-message').style.display = 'none';
    }

    function updateReportHeader(data, params) {
        const reportType = params.type;
        let periodText = '';

        if (reportType === 'daily') {
            const date = new Date(params.date);
            periodText = date.toLocaleDateString('es-DO', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        } else if (reportType === 'weekly') {
            const date = new Date(params.date);
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - date.getDay());
            periodText = `Semana del ${weekStart.toLocaleDateString('es-DO', { month: 'short', day: 'numeric' })} al ${date.toLocaleDateString('es-DO', { month: 'short', day: 'numeric', year: 'numeric' })}`;
        } else { // monthly
            const [year, month] = params.date.split('-');
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            periodText = `${monthNames[parseInt(month) - 1]} ${year}`;
        }

        document.getElementById('report-period').textContent = periodText;
        document.getElementById('report-generation-date').textContent =
            new Date().toLocaleString('es-DO');
        document.getElementById('report-type').textContent =
            reportType === 'daily' ? 'Diario' :
            reportType === 'weekly' ? 'Semanal' : 'Mensual';
    }

    function updateKPIs(data) {
        document.getElementById('total-sales').textContent =
            currencyFormatter.format(data.summary.total_sales || 0);
        document.getElementById('total-transactions').textContent =
            data.summary.total_transactions || 0;
        document.getElementById('avg-sale').textContent =
            currencyFormatter.format(data.summary.avg_sale || 0);

        const profitMargin = data.summary.total_sales > 0 ?
            ((data.summary.total_profit || 0) / data.summary.total_sales * 100) : 0;
        document.getElementById('profit-margin').textContent =
            `${profitMargin.toFixed(1)}%`;
    }

    function createSalesTrendChart(data) {
        const ctx = document.getElementById('salesTrendChart').getContext('2d');

        if (salesTrendChart) salesTrendChart.destroy();

        const chartData = {
            labels: data.chart_labels || [],
            datasets: [{
                label: 'Ventas (RD$)',
                data: data.chart_data || [],
                backgroundColor: 'rgba(52, 132, 240, 0.6)',
                borderColor: 'rgba(52, 132, 240, 1)',
                borderWidth: 2,
                fill: false
            }]
        };

        const config = {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return currencyFormatter.format(value);
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Ventas: ${currencyFormatter.format(context.parsed.y)}`;
                            }
                        }
                    }
                }
            }
        };

        salesTrendChart = new Chart(ctx, config);
    }

    function updateSalesBreakdown(data) {
        const breakdown = data.breakdown || {};

        ['cash', 'card', 'credit', 'transfer'].forEach(type => {
            const amount = breakdown[`${type}_sales`] || 0;
            const total = data.summary.total_sales || 1;
            const percentage = total > 0 ? (amount / total * 100).toFixed(1) : 0;

            document.getElementById(`${type}-sales`).textContent =
                currencyFormatter.format(amount);
            document.getElementById(`${type}-percentage`).textContent =
                `${percentage}%`;
        });
    }

    function updateSalesDetailTable(data) {
        const tableBody = document.getElementById('sales-detail-table-body');
        tableBody.innerHTML = '';

        if (!data.details || data.details.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-muted">
                        <i class="bi bi-receipt-x"></i> No hay transacciones en este periodo
                    </td>
                </tr>
            `;
            return;
        }

        data.details.forEach(sale => {
            const row = document.createElement('tr');
            const saleTime = new Date(sale.fecha).toLocaleTimeString('es-DO', {
                hour: '2-digit',
                minute: '2-digit'
            });

            row.innerHTML = `
                <td>${saleTime}</td>
                <td>#${sale.id || 'N/A'}</td>
                <td>${getPaymentMethodName(sale.tipo_pago)}</td>
                <td>${currencyFormatter.format((sale.total - sale.itbis) || 0)}</td>
                <td>${currencyFormatter.format(sale.itbis || 0)}</td>
                <td>${currencyFormatter.format(sale.descuento || 0)}</td>
                <td class="text-end fw-bold">${currencyFormatter.format(sale.total || 0)}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    function updateTopProducts(data) {
        const grid = document.getElementById('top-products-grid');
        grid.innerHTML = '';

        const topProducts = data.top_products || [];

        if (topProducts.length === 0) {
            grid.innerHTML = `
                <div class="col-12 text-center py-4">
                    <div class="text-muted">
                        <i class="bi bi-trophy-x" style="font-size: 2rem;"></i>
                        <p class="mt-2">No hay datos de productos vendidos</p>
                    </div>
                </div>
            `;
            return;
        }

        topProducts.forEach((product, index) => {
            const rank = index + 1;
            const card = document.createElement('div');
            card.className = 'top-product-card';

            card.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="top-product-rank">${rank}</div>
                    <div class="top-product-info">
                        <h6>${product.nombre || 'Producto sin nombre'}</h6>
                        <div class="top-product-quantity">
                            ${product.total_vendido || 0} unidades vendidas
                        </div>
                    </div>
                </div>
            `;

            grid.appendChild(card);
        });
    }

    function getPaymentMethodName(method) {
        const methodNames = {
            'Efectivo': 'Efectivo',
            'Tarjeta': 'Tarjeta',
            'Cr√©dito': 'Cr√©dito',
            'Transferencia': 'Transferencia'
        };
        return methodNames[method] || method || 'Desconocido';
    }

    function showNoDataMessage() {
        document.getElementById('report-results').style.display = 'none';
        document.getElementById('no-data-message').style.display = 'block';
    }

    function resetFilters() {
        setDefaultDate();
        document.getElementById('report-type-selector').value = 'daily';
        document.getElementById('no-data-message').style.display = 'none';
    }

    // PDF Export
    document.getElementById('export-pdf-btn').addEventListener('click', () => {
        exportReportToPDF();
    });

    async function exportReportToPDF() {
        if (!currentReportData) {
            alert('Primero genera un reporte para poder exportarlo.');
            return;
        }

        // Show loading
        const exportBtn = document.getElementById('export-pdf-btn');
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generando...';
        exportBtn.disabled = true;

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            let yPosition = 20;

            // Header
            doc.setFontSize(18);
            doc.setTextColor(40, 40, 40);
            doc.text('REPORTE DE VENTAS', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 15;

            doc.setFontSize(12);
            doc.text('Sistema Ferreter√≠a - An√°lisis de Ventas', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 10;

            // Period info
            doc.setFontSize(10);
            const reportPeriod = document.getElementById('report-period').textContent;
            const reportDate = document.getElementById('report-generation-date').textContent;
            doc.text(`Periodo: ${reportPeriod}`, 20, yPosition);
            doc.text(`Generado: ${reportDate}`, pageWidth - 20, yPosition, { align: 'right' });
            yPosition += 15;

            // Summary section
            doc.setFontSize(14);
            doc.setTextColor(52, 132, 240);
            doc.text('RESUMEN EJECUTIVO', 20, yPosition);
            yPosition += 10;

            doc.setFontSize(11);
            doc.setTextColor(40, 40, 40);
            const totalSales = document.getElementById('total-sales').textContent;
            const totalTransactions = document.getElementById('total-transactions').textContent;
            const avgSale = document.getElementById('avg-sale').textContent;

            doc.text(`Total Ventas: ${totalSales}`, 20, yPosition);
            yPosition += 8;
            doc.text(`N√∫mero de Transacciones: ${totalTransactions}`, 20, yPosition);
            yPosition += 8;
            doc.text(`Venta Promedio: ${avgSale}`, 20, yPosition);
            yPosition += 15;

            // Sales by payment method
            if (yPosition > pageHeight - 60) {
                doc.addPage();
                yPosition = 20;
            }

            doc.setFontSize(14);
            doc.setTextColor(52, 132, 240);
            doc.text('VENTAS POR M√âTODO DE PAGO', 20, yPosition);
            yPosition += 10;

            doc.setFontSize(10);
            doc.setTextColor(40, 40, 40);

            ['cash', 'card', 'credit', 'transfer'].forEach(type => {
                const amount = document.getElementById(`${type}-sales`).textContent;
                const percentage = document.getElementById(`${type}-percentage`).textContent;
                const methodName = document.getElementById(`${type}-sales`).previousElementSibling.textContent;

                doc.text(`${methodName}: ${amount} (${percentage})`, 20, yPosition);
                yPosition += 6;
            });

            yPosition += 10;

            // Sales detail table
            if (currentReportData.details && currentReportData.details.length > 0) {
                if (yPosition > pageHeight - 80) {
                    doc.addPage();
                    yPosition = 20;
                }

                doc.setFontSize(14);
                doc.setTextColor(52, 132, 240);
                doc.text('DETALLE DE TRANSACCIONES', 20, yPosition);
                yPosition += 10;

                const tableData = currentReportData.details.map(sale => {
                    const time = new Date(sale.fecha).toLocaleTimeString('es-DO', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    return [
                        time,
                        `#${sale.id || 'N/A'}`,
                        getPaymentMethodName(sale.tipo_pago),
                        currencyFormatter.format(sale.total || 0)
                    ];
                });

                doc.autoTable({
                    startY: yPosition,
                    head: [['Hora', 'Factura', 'Pago', 'Total']],
                    body: tableData,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [52, 132, 240], textColor: 255 },
                    margin: { left: 20, right: 20 }
                });

                yPosition = doc.lastAutoTable.finalY + 15;
            }

            // Top products
            if (currentReportData.top_products && currentReportData.top_products.length > 0) {
                if (yPosition > pageHeight - 60) {
                    doc.addPage();
                    yPosition = 20;
                }

                doc.setFontSize(14);
                doc.setTextColor(52, 132, 240);
                doc.text('PRODUCTOS M√ÅS VENDIDOS (TOP 10)', 20, yPosition);
                yPosition += 10;

                const topProductsData = currentReportData.top_products.slice(0, 10).map((product, index) => [
                    (index + 1).toString(),
                    product.nombre || 'N/A',
                    `${product.total_vendido || 0} unidades`
                ]);

                doc.autoTable({
                    startY: yPosition,
                    head: [['Rank', 'Producto', 'Unidades Vendidas']],
                    body: topProductsData,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [40, 167, 69], textColor: 255 },
                    margin: { left: 20, right: 20 }
                });
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`P√°gina ${i} de ${pageCount}`, pageWidth / 2, pageHeight - 20, { align: 'center' });
                doc.text('Sistema Ferreter√≠a - Reporte generado autom√°ticamente', pageWidth / 2, pageHeight - 10, { align: 'center' });
            }

            // Save PDF
            const fileName = `reporte_ventas_${getReportParameters().type}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);

            alert('‚úÖ PDF generado exitosamente y descargado.');

        } catch (error) {
            console.error('Error generating PDF:', error);
            alert('Error al generar el PDF. Verifica la consola para m√°s detalles.');
        } finally {
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
        }
    }

    // Sorting buttons
    document.getElementById('sort-date-btn').addEventListener('click', () => {
        sortSalesTable('date');
    });

    document.getElementById('sort-amount-btn').addEventListener('click', () => {
        sortSalesTable('amount');
    });

    document.getElementById('sort-time-btn').addEventListener('click', () => {
        sortSalesTable('time');
    });

    function sortSalesTable(type) {
        if (!currentReportData || !currentReportData.details) return;

        // Update button states
        ['sort-date-btn', 'sort-amount-btn', 'sort-time-btn'].forEach(btnId => {
            document.getElementById(btnId).classList.remove('active');
        });
        event.target.classList.add('active');

        let sortedData = [...currentReportData.details];

        switch(type) {
            case 'date':
                sortedData.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                break;
            case 'amount':
                sortedData.sort((a, b) => (b.total || 0) - (a.total || 0));
                break;
            case 'time':
            default:
                sortedData.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                break;
        }

        // Update the data and refresh the table
        currentReportData.details = sortedData;
        updateSalesDetailTable(currentReportData);
    }
</script>
{% endblock %}

{% extends "layout.html" %}

{% block title %}Escáner de Inventario{% endblock %}

{% block page_title %}<i class="bi bi-upc-scan"></i> Escáner de Inventario{% endblock %}

{% block breadcrumb %}Escáner{% endblock %}

{% block content %}
<div class="container-fluid d-flex justify-content-center">
    <div class="w-100">
        <ul class="nav nav-tabs" id="scannerTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="product-scanner-tab" data-bs-toggle="tab" data-bs-target="#product-scanner-pane" type="button" role="tab" aria-controls="product-scanner-pane" aria-selected="true"><i class="bi bi-upc-scan"></i> Escáner de Productos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="invoice-scanner-tab" data-bs-toggle="tab" data-bs-target="#invoice-scanner-pane" type="button" role="tab" aria-controls="invoice-scanner-pane" aria-selected="false"><i class="bi bi-receipt-cutoff"></i> Escáner de Facturas</button>
            </li>
        </ul>

        <div class="tab-content pt-3" id="scannerTabsContent">
            <!-- Pestaña: Escáner de Productos -->
            <div class="tab-pane fade show active" id="product-scanner-pane" role="tabpanel" aria-labelledby="product-scanner-tab">
                <div class="row">
                    <!-- Columna Izquierda: Visor de la Cámara -->
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-camera-video-fill"></i> Visor de la Cámara</h5>
                            </div>
                            <div class="card-body text-center d-flex flex-column align-items-center justify-content-center">
                                <!-- Contenedor del visor de la cámara -->
                                <div id="interactive" class="viewport mx-auto" style="max-width: 480px; min-height: 360px; position: relative; background: #000; border-radius: 8px; overflow: hidden;">
                                    <!-- El video y el canvas de QuaggaJS se insertarán aquí -->
                                    <video autoplay="true" preload="auto" src="" style="width: 100%; height: 100%; object-fit: cover; filter: brightness(1.3) contrast(1.1) saturate(1.2);"></video>
                                    <canvas class="drawingBuffer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>

                                    <!-- Overlay que se ocultará cuando la cámara esté activa -->
                                    <div id="camera-overlay" class="d-flex justify-content-center align-items-center" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); cursor: pointer;">
                                        <!-- El botón de activación está ahora dentro del overlay -->
                                    </div>
                                </div>

                                <!-- Mensaje de instrucción y botón de activación -->
                                <div id="activation-container" class="mt-3">
                                    <p class="text-muted mb-2" id="camera-instruction-message">Haz clic en "Activar Cámara" para iniciar el escáner</p>
                                    <button id="activate-camera-btn" class="btn btn-primary btn-lg">
                                        <i class="bi bi-camera-fill"></i> Activar Cámara
                                    </button>
                                </div>

                                <div id="scanner-status" class="mt-2 text-muted"></div>
                                <button id="toggle-camera-btn" class="btn btn-sm btn-outline-info mt-2" style="display: none;">
                                    <i class="bi bi-arrow-repeat"></i> Cambiar Cámara
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Columna Derecha: Panel de Productos Escaneados -->
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="bi bi-list-check text-success"></i> Productos Escaneados</h5>
                                    <span id="products-count" class="badge bg-secondary rounded-pill">0 productos</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="product-list" style="max-height: 400px; overflow-y: auto;">
                                    <div class="text-center text-muted p-5">
                                        <i class="bi bi-box-seam" style="font-size: 3rem;"></i>
                                        <p class="mt-2">Los productos escaneados aparecerán aquí.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer text-end">
                                <button id="confirm-stock" class="btn btn-success">
                                    <i class="bi bi-check-circle-fill"></i> Confirmar y Agregar al Stock
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Escáner de Facturas -->
            <div class="tab-pane fade" id="invoice-scanner-pane" role="tabpanel" aria-labelledby="invoice-scanner-tab">
                <div class="row">
                    <!-- Columna de Carga -->
                    <div class="col-lg-4 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-upload"></i> 1. Cargar Imagen de la Factura</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Sube una foto clara de la factura o usa la cámara de tu dispositivo.</p>
                                <div class="input-group mb-3">
                                    <input type="file" class="form-control" id="invoice-image-upload" accept="image/*" style="border-top-right-radius: 0; border-bottom-right-radius: 0;">
                                    <button class="btn btn-outline-secondary" type="button" id="take-photo-btn"><i class="bi bi-camera-fill"></i> Tomar Foto</button>
                                </div>
                                <!-- Contenedor para la cámara -->
                                <div id="camera-container" class="mb-3" style="display: none;">
                                    <video id="camera-stream" width="100%" autoplay playsinline></video>
                                    <button class="btn btn-success w-100 mt-2" id="capture-btn">Capturar Imagen</button>
                                </div>

                                <div class="d-grid">
                                    <button class="btn btn-primary" id="process-image-btn" disabled data-bs-toggle="tooltip" data-bs-placement="top" title="Seleccione una imagen para activar">
                                        <i class="bi bi-gear-fill"></i> Procesar Imagen
                                    </button>
                                </div>
                                <div id="image-preview-container" class="mt-3" style="display: none;">
                                    <h6>Vista Previa:</h6>
                                    <img id="image-preview" src="#" alt="Vista previa de la factura" class="img-fluid rounded border">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna de Resultados -->
                    <div class="col-lg-8">
                        <div class="card shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-pencil-square"></i> 2. Revisar y Completar Datos</h5>
                                <button class="btn btn-success" id="add-to-inventory-btn" style="display: none;">
                                    <i class="bi bi-check-circle-fill"></i> Agregar Productos al Inventario
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="results-container">
                                    <div id="initial-state" class="text-center text-muted p-5">
                                        <i class="bi bi-card-text" style="font-size: 3rem;"></i>
                                        <p class="mt-2">Los productos extraídos de la factura aparecerán aquí.</p>
                                    </div>
                                    <div id="loading-state" class="text-center p-5" style="display: none;">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Procesando...</span>
                                        </div>
                                        <p class="mt-3">Analizando factura, por favor espere...</p>
                                    </div>
                                    <div class="table-responsive" id="results-table-container" style="display: none;">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Nombre del Producto (Editable)</th>
                                                    <th>Cantidad</th>
                                                    <th>Precio Costo (Editable)</th>
                                                    <th>Precio Venta (Requerido)</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="results-table-body">
                                                <!-- Filas de productos extraídos -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Nuevo Producto -->
<div class="modal fade" id="editNewProductModal" tabindex="-1" aria-labelledby="editNewProductModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editNewProductModalLabel"><i class="bi bi-pencil-square"></i> Editar Nuevo Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-product-id">
        <div class="mb-3">
          <label for="edit-product-name" class="form-label">Nombre del Producto</label>
          <input type="text" class="form-control" id="edit-product-name">
        </div>
        <div class="mb-3">
          <label for="edit-product-price" class="form-label">Precio de Venta (RD$)</label>
          <input type="number" class="form-control" id="edit-product-price" min="0" step="0.01">
        </div>
        <div class="alert alert-info small">
            <i class="bi bi-info-circle-fill"></i>
            El costo y el stock mínimo se pueden ajustar más tarde desde la página de Inventario.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="save-product-changes-btn">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>

<!-- Loader -->
<div id="loader" class="d-none justify-content-center align-items-center" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); z-index: 1060;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
</div>

<!-- Toast para notificaciones (reutilizado para ambas pestañas) -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="toast-element" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
        <div class="toast-body" id="toast-message"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="{{ url_for('static', filename='js/scanner.js') }}"></script>
<script src="{{ url_for('static', filename='js/invoice_scanner.js') }}"></script>

<script>
    // --- FUNCIONES GLOBALES ACCESIBLES ---
    // Delegador ligero: llama al handler principal definido en `static/js/scanner.js`
    function confirmarIngresoStock() {
        const btn = document.getElementById('confirm-stock');
        if (btn) btn.click();
    }

    // --- FUNCIONES DE AUDIO MEJORADAS PARA ESCÁNER ---
    function playSuccessBeep() {
        if (!('Audio' in window)) {
            console.log('Web Audio API no disponible');
            return;
        }

        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);

            gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        } catch (e) {
            console.log('Beep de éxito no disponible:', e.message);
        }
    }

    function playErrorBeep() {
        if (!('Audio' in window)) {
            console.log('Web Audio API no disponible');
            return;
        }

        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } catch (e) {
            console.log('Beep de error no disponible:', e.message);
        }
    }

    // Función de compatibilidad para código existente
    function playBeep(success = true) {
        if (success) {
            playSuccessBeep();
        } else {
            playErrorBeep();
        }
    }

    // --- LÓGICA PRINCIPAL ---
    document.addEventListener('DOMContentLoaded', function() {
        // Activar cámara del escáner de productos automáticamente
        const activateCameraButton = document.getElementById('activate-camera-btn');
        if (activateCameraButton) {
            // Simular clic para iniciar la cámara al cargar la página
            activateCameraButton.click();
        }

        // Lógica del escáner de facturas
        const invoiceImageUpload = document.getElementById('invoice-image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const processImageBtn = document.getElementById('process-image-btn');
        const processBtnTooltip = new bootstrap.Tooltip(processImageBtn); // Initialize tooltip

        // --- Lógica para habilitar el botón de procesar imagen al seleccionar un archivo ---
        if (invoiceImageUpload) {
            invoiceImageUpload.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreviewContainer.style.display = 'block';
                        processImageBtn.disabled = false;
                        processBtnTooltip.hide(); // Hide tooltip when enabled
                        stopCamera(); // Stop camera if a file is selected
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.src = '#';
                    imagePreviewContainer.style.display = 'none';
                    processImageBtn.disabled = true;
                    processBtnTooltip.show(); // Show tooltip when disabled
                }
            });
        }

        // --- Lógica para tomar foto ---
        const takePhotoButton = document.getElementById('take-photo-btn');
        const cameraContainer = document.getElementById('camera-container');
        const videoElement = document.getElementById('camera-stream');
        const captureButton = document.getElementById('capture-btn');
        let stream = null;

        async function startCamera() {
            try {
                if (stream) {
                    stopCamera(); // Stop any existing stream
                }
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoElement.srcObject = stream;
                cameraContainer.style.display = 'block';
                imagePreviewContainer.style.display = 'none'; // Hide file preview
                invoiceImageUpload.value = ''; // Clear file input
                processImageBtn.disabled = true; // Disable process button until photo is captured
                processBtnTooltip.show();
            } catch (err) {
                console.error("Error al acceder a la cámara: ", err);
                alert("No se pudo acceder a la cámara. Asegúrate de haber otorgado los permisos.");
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            cameraContainer.style.display = 'none';
        }

        if (takePhotoButton) {
            takePhotoButton.addEventListener('click', startCamera);
        }

        if (captureButton) {
            captureButton.addEventListener('click', () => {
                const canvas = document.createElement('canvas');
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

                imagePreview.src = canvas.toDataURL('image/jpeg');
                imagePreviewContainer.style.display = 'block';
                processImageBtn.disabled = false;
                processBtnTooltip.hide();
                stopCamera();
            });
        }
    });
</script>
{% endblock %}

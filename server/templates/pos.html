{% extends "layout.html" %}

{% block title %}Punto de Venta - Sistema Ferreter√≠a{% endblock %}

{% block page_title %}<i class="bi bi-cart-check-fill"></i> Punto de Venta{% endblock %}

{% block breadcrumb %}Sistema POS{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- HEADER DEL POS -->
    <div class="pos-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3 class="mb-0"><i class="bi bi-cart-check"></i> Punto de Venta</h3>
                <small class="text-muted">Sesi√≥n activa - Venta en progreso</small>
            </div>
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="frequent-products-dropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-star-fill"></i> Favoritos
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="frequent-products-dropdown" id="frequent-products-list">
                    <!-- Los productos frecuentes se cargar√°n aqu√≠ -->
                    <li><a class="dropdown-item text-muted" href="#">Cargando...</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- PANEL IZQUIERDO: PRODUCTOS -->
        <div class="col-lg-7">
            <!-- ESC√ÅNER M√ìVIL FLOTANTE -->
            <div id="floating-scanner-container" class="floating-scanner-container" style="display: none;">
                <div class="floating-scanner-panel">
                    <div class="floating-scanner-header">
                        <h6 class="mb-0"><i class="bi bi-camera"></i> Esc√°ner Inal√°mbrico</h6>
                        <button id="close-floating-scanner" class="btn-close btn-sm" aria-label="Close"></button>
                    </div>
                    <div class="floating-scanner-body">
                        <!-- Esc√°ner embebido -->
                        <div class="scanner-mini-view">
                            <div id="floating-scanner-target" class="floating-scanner-target">
                                <!-- Aqu√≠ se incrustar√° el esc√°ner m√≥vil -->
                            </div>
                        </div>
                        <div class="floating-scanner-controls mt-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <select id="floating-scanner-mode" class="form-select form-select-sm">
                                        <option value="auto">Autom√°tico</option>
                                        <option value="mobile">M√≥vil + Servidor</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <button id="open-full-scanner" class="btn btn-primary btn-sm w-100">
                                        <i class="bi bi-arrow-diagonal"></i> Pantalla Completa
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BOT√ìN FLOTANTE PARA ACTIVAR ESC√ÅNER -->
            <button id="fab-scanner" class="fab-scanner" title="Esc√°ner M√≥vil">
                <i class="bi bi-upc-scan"></i>
            </button>

            <!-- B√öSQUEDA R√ÅPIDA -->
            <div class="search-section mb-4">
                <div class="row g-3">
                    <div class="col-md-12">
                        <div class="search-card">
                            <div class="search-icon">
                                <i class="bi bi-search"></i>
                            </div>
                            <div class="search-input flex-grow-1">
                                <label class="search-label">Buscar o Escanear Producto</label>
                                <div class="input-group">
                                    <input type="text" id="product-search" class="form-control" placeholder="Nombre del producto...">
                                    <button class="btn btn-outline-secondary" type="button" id="clear-search-btn" title="Limpiar b√∫squeda" style="display: none;">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#scannerModal" title="Abrir esc√°ner de c√°mara">
                                        <i class="bi bi-upc-scan"></i>
                                    </button>
                                    <button class="btn btn-primary" type="button" id="add-product-btn" title="A√±adir producto buscado">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                </div>
                                <div id="product-results" class="search-results"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SELECCI√ìN DE CLIENTE -->
                <div class="row g-3 mt-1">
                    <div class="col-12">
                        <div class="client-selection">
                            <div class="client-icon">
                                <i class="bi bi-person-circle"></i>
                            </div>
                            <div class="flex-grow-1">
                                <label class="form-label mb-1">Cliente</label>
                                <div class="input-group">
                                    <input type="text" id="client-search" class="form-control" placeholder="Buscar por nombre o RNC...">
                                    <button class="btn btn-outline-secondary" type="button" id="clear-client-btn">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>
                                <div id="client-results" class="search-results mt-1"></div>
                            </div>
                            <div id="selected-client-display" class="client-display ms-3">
                                <div class="client-info-placeholder">
                                    <i class="bi bi-person"></i>
                                    <small>Consumidor Final</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LISTA DE PRODUCTOS DE VENTA -->
            <div class="sale-items-panel">
                <div class="panel-header">
                    <h4 class="panel-title"><i class="bi bi-cart3"></i> Productos en Venta</h4>
                    <div class="panel-stats">
                        <span id="total-items-label" class="stat-badge">0 items</span>
                        <span id="total-units-label" class="stat-badge">0 unidades</span>
                    </div>
                </div>

                <div class="panel-tools">
                    <div class="tool-buttons">
                        <button id="modify-qty-btn" class="tool-btn" disabled>
                            <i class="bi bi-pencil-square"></i> Modificar
                        </button>
                        <button id="delete-item-btn" class="tool-btn danger" disabled>
                            <i class="bi bi-trash3"></i> Eliminar
                        </button>
                        <button id="return-item-btn" class="tool-btn warning" disabled>
                            <i class="bi bi-arrow-return-left"></i> Devolver
                        </button>
                    </div>
                    <button id="select-all-btn" class="select-all-btn">
                        <input type="checkbox" id="select-all-checkbox">
                        <label for="select-all-checkbox">Seleccionar todo</label>
                    </button>
                </div>

                <div class="items-container">
                    <div id="empty-cart-message" class="empty-cart">
                        <i class="bi bi-cart-x"></i>
                        <h5>No hay productos en la venta</h5>
                        <p>Agregue productos usando el buscador o c√≥digo de barras</p>
                    </div>

                    <div id="sale-items" class="items-list">
                        <!-- Los items se insertan aqu√≠ din√°micamente -->
                    </div>
                </div>
            </div>

        </div>

        <!-- PANEL DERECHO: RESUMEN Y ACCIONES -->
        <div class="col-lg-5">
            <!-- PANEL DE VENTA RESUMEN -->
            <div class="checkout-panel">
                <!-- HEADER -->
                <div class="checkout-header">
                    <h3 class="checkout-title"><i class="bi bi-receipt"></i> Resumen de Venta</h3>
                </div>

                <!-- INFORMACI√ìN DEL CLIENTE -->
                <div class="client-summary" id="client-summary">
                    <div class="client-avatar">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <div class="client-details">
                        <div class="client-name">Consumidor Final</div>
                        <button class="change-client-btn" id="change-client-btn">
                            <i class="bi bi-pencil"></i> Cambiar
                        </button>
                    </div>
                </div>

                <!-- RESUMEN FINANCIERO -->
                <div class="financial-summary">
                    <div class="summary-row base-amount">
                        <span class="label">Subtotal base</span>
                        <span class="value" id="subtotal-base">RD$ 0.00</span>
                    </div>

                    <div class="summary-row discount-row" id="discount-row">
                        <span class="label">Descuento</span>
                        <span class="value discount" id="discount-display">- RD$ 0.00</span>
                    </div>

                    <div class="summary-row tax-row">
                        <span class="label">ITBIS (18%)</span>
                        <span class="value tax" id="itbis">RD$ 0.00</span>
                    </div>

                    <div class="summary-divider"></div>

                    <div class="summary-row total-row">
                        <span class="label-total">TOTAL A PAGAR</span>
                        <span class="value-total" id="total">RD$ 0.00</span>
                    </div>
                </div>

                <!-- M√âTODO DE PAGO -->
                <div class="payment-section">
                    <label class="payment-label">M√©todo de Pago</label>
                    <select class="payment-select" id="payment-method">
                        <option value="Efectivo">üíµ Efectivo</option>
                        <option value="Tarjeta">üí≥ Tarjeta de Cr√©dito/D√©bito</option>
                        <option value="Cr√©dito">üìã Cr√©dito (Cliente)</option>
                        <option value="Transferencia">üè¶ Transferencia</option>
                    </select>
                </div>

                <!-- DESCUENTO -->
                <div class="discount-section">
                    <button class="discount-btn" id="discount-btn">
                        <i class="bi bi-percent"></i>
                        Aplicar Descuento
                    </button>
                </div>

                <!-- ACCIONES PRINCIPALES -->
                <div class="actions-section">
                    <button class="primary-action" id="finalize-sale-btn">
                        <i class="bi bi-check-circle-fill"></i>
                        <span class="action-text">FINALIZAR VENTA</span>
                        <span class="action-shortcut">F12</span>
                    </button>

                    <div class="secondary-actions">
                        <button class="secondary-action cancel" id="cancel-sale-btn">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button class="secondary-action hold" id="hold-sale-btn">
                            <i class="bi bi-pause-circle"></i> Pausar
                        </button>
                        <button class="secondary-action info" id="view-held-sales-btn">
                            <i class="bi bi-list-task"></i> Ver Pausadas
                            <span id="held-sales-count" class="badge bg-danger ms-1" style="display: none;">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA APLICAR DESCUENTO -->
<div class="modal fade" id="discountModal" tabindex="-1" aria-labelledby="discountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="discountModalLabel"><i class="bi bi-percent"></i> Aplicar Descuento a la Venta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="discount-type" class="form-label">Tipo de Descuento</label>
                    <select class="form-select" id="discount-type-modal">
                        <option value="percentage">Porcentaje (%)</option>
                        <option value="fixed">Monto Fijo (RD$)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="discount-value" class="form-label">Valor del Descuento</label>
                    <input type="number" class="form-control" id="discount-value-modal" step="0.01" min="0" value="0">
                </div>
                <div class="alert alert-info mt-3">
                    Subtotal Bruto: <strong id="discount-subtotal-display">RD$ 0.00</strong><br>
                    Descuento Aplicado: <strong id="discount-applied-display">RD$ 0.00</strong><br>
                    Nuevo Subtotal: <strong id="discount-new-subtotal-display">RD$ 0.00</strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="confirm-discount-btn">Aplicar Descuento</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA FINALIZAR VENTA (PAGO) -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="paymentModalLabel"><i class="bi bi-cash-coin"></i> Finalizar Venta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="mb-3">Resumen de la Venta</h6>
                        <div class="border p-3 mb-3 bg-light rounded">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span class="fw-bold" id="payment-subtotal-display">RD$ 0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Descuento:</span>
                                <span class="fw-bold text-success" id="payment-discount-display">- RD$ 0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>ITBIS (18%):</span>
                                <span class="fw-bold" id="payment-itbis-display">RD$ 0.00</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fs-4 fw-bold">
                                <span>Total a Pagar:</span>
                                <span class="text-primary" id="payment-total-display">RD$ 0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 border-start">
                        <h6 class="mb-3">Registrar Pagos</h6>
                        <div class="d-flex justify-content-between fs-5 fw-bold mb-3">
                            <span>Restante:</span>
                            <span class="text-danger" id="payment-remaining-display">RD$ 0.00</span>
                        </div>
                        <div class="input-group mb-3">
                            <select class="form-select" id="split-payment-method" style="flex-grow: 2;">
                                <option value="Efectivo">üíµ Efectivo</option>
                                <option value="Tarjeta">üí≥ Tarjeta</option>
                                <option value="Transferencia">üè¶ Transferencia</option>
                                <option value="Cr√©dito">üìã Cr√©dito</option>
                            </select>
                            <span class="input-group-text">RD$</span>
                            <input type="number" class="form-control" id="split-payment-amount" placeholder="Monto">
                            <button class="btn btn-primary" id="add-split-payment-btn">
                                <i class="bi bi-plus-lg"></i> Agregar Pago
                            </button>
                        </div>
                        <hr>
                        <h6>Pagos Realizados</h6>
                        <div id="split-payments-list" class="list-group mb-3" style="max-height: 150px; overflow-y: auto;">
                            <!-- Pagos divididos se insertan aqu√≠ -->
                        </div>
                        <div class="d-flex justify-content-between fs-5 fw-bold">
                            <span>Cambio:</span>
                            <span class="text-success" id="payment-change-display">RD$ 0.00</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="confirm-payment-btn" disabled>
                    <i class="bi bi-check-circle"></i> Confirmar Venta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA VER VENTAS EN ESPERA -->
<div class="modal fade" id="heldSalesModal" tabindex="-1" aria-labelledby="heldSalesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="heldSalesModalLabel"><i class="bi bi-pause-circle-fill"></i> Ventas en Espera</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="hold-list-container">
                    <!-- La lista de ventas pausadas se insertar√° aqu√≠ -->
                </div>
                <div id="no-held-sales-message" class="text-center p-5" style="display: none;">
                    <i class="bi bi-emoji-smile text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">No hay ventas en espera</h5>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALES -->
<!-- MODAL PARA DEVOLUCIONES -->
<div class="modal fade" id="returnsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-arrow-return-left"></i> Procesar Devoluci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Advertencia:</strong> Esta acci√≥n devolver√° los productos seleccionados al inventario.
                </div>

                <div id="return-items-list" class="mt-3">
                    <!-- Items a devolver se mostrar√°n aqu√≠ -->
                </div>

                <div class="mt-3">
                    <label class="form-label">Raz√≥n de la devoluci√≥n:</label>
                    <select class="form-select" id="return-reason">
                        <option value="defecto">Producto defectuoso</option>
                        <option value="insatisfaccion">Insatisfacci√≥n del cliente</option>
                        <option value="cambio">Cambio por otro producto</option>
                        <option value="equivocado">Producto equivocado</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="confirm-return-btn">
                    <i class="bi bi-arrow-return-left"></i> Confirmar Devoluci√≥n
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA CAMBIAR CLIENTE -->
<div class="modal fade" id="clientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person"></i> Seleccionar Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="client-search-modal" class="form-control" placeholder="Buscar por nombre o RNC...">
                    <button class="btn btn-outline-secondary" type="button" onclick="clearClientSelection()">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </button>
                </div>
                <div id="client-results-modal"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA ACTUALIZAR CLIENTE EN VENTA DE CR√âDITO (DESPU√âS DE FINALIZAR) -->
<div class="modal fade" id="updateCreditClientModal" tabindex="-1" aria-labelledby="updateCreditClientLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="updateCreditClientLabel"><i class="bi bi-person-check"></i> Asociar Cliente a Venta a Cr√©dito</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>Venta pendiente de cliente:</strong> Esta venta fue registrada a cr√©dito sin cliente espec√≠fico. Puedes asociarla a un cliente ahora.
                </div>
                <div class="input-group mb-3">
                    <input type="text" id="update-client-search" class="form-control" placeholder="Buscar cliente por nombre o RNC...">
                    <button class="btn btn-outline-secondary" type="button" id="clear-update-client-btn">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </button>
                </div>
                <div id="update-client-results" class="search-results"></div>
                <small class="text-muted d-block mt-2">
                    <i class="bi bi-lightbulb"></i> Si no encuentras el cliente, puedes crearlo desde la secci√≥n de Clientes y volver despu√©s para asociarlo.
                </small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar (Hacerlo despu√©s)</button>
                <button type="button" class="btn btn-info" id="confirm-update-credit-client-btn" disabled>
                    <i class="bi bi-check-circle"></i> Asociar Cliente
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal del Esc√°ner -->
<div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scannerModalLabel"><i class="bi bi-upc-scan"></i> Esc√°ner de C√≥digo de Barras</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted text-center">Apunte la c√°mara al c√≥digo de barras del producto.</p>
                <div id="interactive" class="viewport" style="position: relative; min-height: 200px;">
                    <video autoplay="true" preload="auto" src="" style="width: 100%; height: auto;"></video>
                    <canvas class="drawingBuffer" style="position: absolute; top: 0; left: 0;"></canvas>
                </div>
                <div id="scanner-status" class="mt-2 text-center"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de B√∫squeda de Cliente (Reutilizado) -->
<div class="modal fade" id="clientSearchModal" tabindex="-1" aria-labelledby="clientSearchModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="clientSearchModalLabel">Buscar Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="client-search-input" class="form-control" placeholder="Escriba nombre o RNC/C√©dula...">
        <div id="client-search-results" class="list-group mt-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- Toast para notificaciones -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="toast-element" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
        <div class="toast-body" id="toast-message">
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- Incluir scanner para poder usarlo con el m√≥vil -->
<script src="{{ url_for('static', filename='js/scanner.js') }}"></script>

<script>
// --- Estado de la Aplicaci√≥n ---
let saleItems = {};
let selectedClient = null; // Inicialmente null, se asigna al seleccionar un cliente
let discount = 0.0; // Descuento inicial
const ITBIS_RATE = 0.18;

// --- Exponer funciones para integraci√≥n con scanner ---
window.scannerAddToCart = addProductToSale;
window.posCart = {
    addItem: addProductToSale
};
window.isPosMode = true;

document.addEventListener('DOMContentLoaded', () => {
    // Configurar eventos iniciales del POS
    setupEventListeners();

    // Inicializar referencias a elementos del DOM del POS
    const clientDisplayElement = document.getElementById('selected-client-display');
    // Cargar productos frecuentes
    let splitPayments = [];
    renderFrequentProducts();

    if (clientDisplayElement) {
        clientDisplayDiv = clientDisplayElement;
    }
});

// --- Selectores de Elementos del DOM ---
const barcodeInput = document.getElementById('barcode-input');
const productSearchInput = document.getElementById('product-search');
const productResultsDiv = document.getElementById('product-results');
const clientSearchInput = document.getElementById('client-search');
const clientResultsDiv = document.getElementById('client-results');
const saleItemsContainer = document.getElementById('sale-items');
const subtotalBaseSpan = document.getElementById('subtotal-base');
const discountDisplaySpan = document.getElementById('discount-display');
const itbisSpan = document.getElementById('itbis');
const totalSpan = document.getElementById('total');
const clientSummaryDiv = document.getElementById('client-summary');
const clearClientBtn = document.getElementById('clear-client-btn');
const changeClientBtn = document.getElementById('change-client-btn');
const totalItemsLabel = document.getElementById('total-items-label');
const totalUnitsLabel = document.getElementById('total-units-label');
const discountBtn = document.getElementById('discount-btn');
const paymentMethodSelect = document.getElementById('payment-method');
const finalizeSaleBtn = document.getElementById('finalize-sale-btn');
const cancelSaleBtn = document.getElementById('cancel-sale-btn');
const modifyQtyBtn = document.getElementById('modify-qty-btn');
const deleteItemBtn = document.getElementById('delete-item-btn');
const returnItemBtn = document.getElementById('return-item-btn');
const selectAllBtn = document.getElementById('select-all-btn');
const selectAllCheckbox = document.getElementById('select-all-checkbox');
const addProductBtn = document.getElementById('add-product-btn');

const heldSalesModal = new bootstrap.Modal(document.getElementById('heldSalesModal'));
const discountModal = new bootstrap.Modal(document.getElementById('discountModal'));
const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));

let clientDisplayDiv; // Define despu√©s de que el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
    // Inicializar elementos del FAB y Scanner flotante
    const fabScanner = document.getElementById('fab-scanner');
    const floatingScannerContainer = document.getElementById('floating-scanner-container');
    const closeFloatingScanner = document.getElementById('close-floating-scanner');
    const openFullScanner = document.getElementById('open-full-scanner');
    const floatingScannerMode = document.getElementById('floating-scanner-mode');

    // Crear elementos din√°micos del esc√°ner flotante
    initializeFloatingScanner();

    function initializeFloatingScanner() {
        const scannerTarget = document.getElementById('floating-scanner-target');
        if (!scannerTarget) {
            console.error('Floating scanner target not found');
            return;
        }

        // Crear elementos del esc√°ner flotante
        scannerTarget.innerHTML = `
            <div id="floating-scanner-auto" style="display: none; width: 100%; height: 100%; position: relative;">
                <!-- Aqu√≠ va el esc√°ner autom√°tico flotante -->
                <div id="floating-interactive" style="width: 100%; height: 100%; position: relative;"></div>
            </div>
            <div id="floating-scanner-mobile" style="display: none; width: 100%; height: 100%; position: relative;">
                <video id="floating-mobile-video" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover;"></video>
                <canvas id="floating-mobile-canvas" style="display: none;"></canvas>
                <button id="floating-capture-frame-btn" class="btn btn-success btn-sm" style="position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%);">
                    <i class="bi bi-camera"></i> Capturar
                </button>
            </div>
        `;

        // Event listeners para el FAB
        if (fabScanner) {
            fabScanner.addEventListener('click', showFloatingScanner);
        }

        // Event listeners para controles del esc√°ner flotante
        if (closeFloatingScanner) {
            closeFloatingScanner.addEventListener('click', hideFloatingScanner);
        }

        if (floatingScannerContainer) {
            floatingScannerContainer.addEventListener('click', function(e) {
                if (e.target === floatingScannerContainer) {
                    hideFloatingScanner();
                }
            });
        }

        if (openFullScanner) {
            openFullScanner.addEventListener('click', function() {
                window.location.href = '/scanner';
            });
        }

        if (floatingScannerMode) {
            floatingScannerMode.addEventListener('change', function(e) {
                changeFloatingScannerMode(e.target.value);
            });
        }
    }

    function showFloatingScanner() {
        if (floatingScannerContainer) {
            floatingScannerContainer.style.display = 'flex';
            changeFloatingScannerMode('auto'); // Iniciar en modo autom√°tico
        }
    }

    function hideFloatingScanner() {
        if (floatingScannerContainer) {
            floatingScannerContainer.style.display = 'none';

            // Detener cualquier esc√°ner activo flotante
            stopFloatingScanner();
        }
    }

    function changeFloatingScannerMode(mode) {
        const autoDiv = document.getElementById('floating-scanner-auto');
        const mobileDiv = document.getElementById('floating-scanner-mobile');
        const scannerTarget = document.getElementById('floating-scanner-target');

        if (!autoDiv || !mobileDiv || !scannerTarget) return;

        // Detener primero cualquier scanner activo
        stopFloatingScanner();

        // Cambiar modo
        if (mode === 'auto') {
            autoDiv.style.display = 'block';
            mobileDiv.style.display = 'none';
            scannerTarget.classList.add('auto-mode');
            scannerTarget.classList.remove('mobile-mode');

            // Iniciar esc√°ner autom√°tico flotante
            setTimeout(() => initFloatingAutoScanner(), 100);
        } else if (mode === 'mobile') {
            autoDiv.style.display = 'none';
            mobileDiv.style.display = 'block';
            scannerTarget.classList.remove('auto-mode');
            scannerTarget.classList.add('mobile-mode');

            // Iniciar esc√°ner m√≥vil flotante
            setTimeout(() => initFloatingMobileScanner(), 100);
        }
    }

    function initFloatingAutoScanner() {
        // Usar las funciones principales del scanner.js
        if (window.setScannerMode && window.isPosMode) {
            window.setScannerMode('auto', true);
        }
    }

    function initFloatingMobileScanner() {
        // Usar las funciones m√≥viles del scanner.js
        if (window.setScannerMode && window.isPosMode) {
            window.setScannerMode('mobile', true);
        }
    }

    function stopFloatingScanner() {
        // Limpiar estados del scanner
        if (window.stopScanner) {
            window.stopScanner();
        }
        if (window.stopMobileScanner) {
            window.stopMobileScanner();
        }
    }

    // Update the modal event listeners for the POS scanner
    const scannerModal = document.getElementById('scannerModal');
    if (scannerModal) {
        scannerModal.addEventListener('shown.bs.modal', () => window.posScanner.init());
        scannerModal.addEventListener('hide.bs.modal', () => window.posScanner.stop());
    }
});

function setupEventListeners() {
    // --- Escaneo de C√≥digo de Barras ---
    let barcodeScanTimeout;

    if (barcodeInput) {
        barcodeInput.addEventListener('input', async (e) => {
            const input = e.target;
            const barcode = input.value.trim();

            // Limpiar timeout anterior
            if (barcodeScanTimeout) {
                clearTimeout(barcodeScanTimeout);
            }

            // Si no hay caracteres, salir
            if (!barcode) return;

            // Si el c√≥digo es demasiado corto, esperar m√°s input
            if (barcode.length < 8) return;

            // Si el c√≥digo parece completo (8-13 caracteres, solo d√≠gitos), procesar autom√°ticamente
            if (barcode.length >= 8 && barcode.length <= 13 && /^[0-9]+$/.test(barcode)) {
                // Procesar inmediatamente si parece un c√≥digo de barras v√°lido
                processBarcodeScanForPOS(barcode);
            } else if (barcode.length > 13) {
                // Si es muy largo, podr√≠a ser ingreso manual o c√≥digo largo, procesar con delay
                barcodeScanTimeout = setTimeout(() => {
                    if (input.value.trim() === barcode) {
                        processBarcodeScanForPOS(barcode);
                    }
                }, 300);
            }
        });

        // Tambi√©n mantener el m√©todo manual con Enter por si acaso
        barcodeInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const barcode = barcodeInput.value.trim();
                if (barcode) {
                    processBarcodeScanForPOS(barcode);
                }
            }
        });
    }

    async function processBarcodeScanForPOS(barcode) {
        const input = barcodeInput;

        // Limpiar timeout si existe
        if (barcodeScanTimeout) {
            clearTimeout(barcodeScanTimeout);
        }

        // Limpiar el campo
        input.value = '';
        input.focus();

        try {
            const response = await fetch('/api/scan_product', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ barcode: barcode })
            });

            const result = await response.json();

            if (result.success) {
                addProductToSale(result.product);

                // Reproducir beep de √©xito si est√° disponible
                if ('Audio' in window) {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);

                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                    } catch (e) {
                        console.log('Beep no disponible');
                    }
                }
            } else {
                // Reproducir beep de error
                if ('Audio' in window) {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                    } catch (e) {
                        console.log('Beep de error no disponible');
                    }
                }

                alert(`Producto no encontrado: ${result.error}`);
            }
        } catch (error) {
            alert('Error de conexi√≥n al buscar el producto.');
        }
    }

    // --- L√≥gica de B√∫squeda de Productos ---
    if (productSearchInput) {
        productSearchInput.addEventListener('keyup', async (e) => {
            const term = e.target.value;
            if (term.length < 3) {
                if (productResultsDiv) productResultsDiv.innerHTML = '';
                return;
            }
            await performProductSearch(term);
        });

        // Mostrar/ocultar bot√≥n de limpiar b√∫squeda
        productSearchInput.addEventListener('input', () => {
            const clearBtn = document.getElementById('clear-search-btn');
            if (productSearchInput.value.length > 0) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
                if (productResultsDiv) productResultsDiv.innerHTML = '';
            }
        });

        document.getElementById('clear-search-btn').addEventListener('click', () => {
            productSearchInput.value = '';
            productSearchInput.dispatchEvent(new Event('input')); // Disparar evento para ocultar el bot√≥n y limpiar resultados
        });
    }

    // Bot√≥n para forzar b√∫squeda manual
    if (addProductBtn) {
        addProductBtn.addEventListener('click', async () => {
            const term = productSearchInput ? productSearchInput.value.trim() : '';
            if (term.length >= 3) {
                await performProductSearch(term);
            } else {
                alert('Ingrese al menos 3 caracteres para buscar productos.');
                if (productSearchInput) productSearchInput.focus();
            }
        });
    }

    // --- B√∫squeda de Clientes ---
    if (clientSearchInput) {
        clientSearchInput.addEventListener('keyup', async (e) => {
            const term = e.target.value;
            if (term.length < 2) {
                if (clientResultsDiv) clientResultsDiv.innerHTML = '';
                return;
            }
            await performClientSearch(term);
        });
    }

    // Configurar eventos iniciales para otros botones
    if (changeClientBtn) {
        changeClientBtn.addEventListener('click', showClientModal);
    }

    if (clearClientBtn) {
        clearClientBtn.addEventListener('click', () => {
            selectedClient = null;
            if (clientDisplayDiv) {
                clientDisplayDiv.innerHTML = `<div class="client-info-placeholder">
                    <i class="bi bi-person"></i>
                    <small>Consumidor Final</small>
                </div>`;
            }
            if (clientSummaryDiv) {
                clientSummaryDiv.innerHTML = `
                    <div class="client-avatar">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <div class="client-details">
                        <div class="client-name">Consumidor Final</div>
                        <button class="change-client-btn" id="change-client-btn">
                            <i class="bi bi-pencil"></i> Cambiar
                        </button>
                    </div>
                `;
            }
            clearClientBtn.style.display = 'none';
            if (paymentMethodSelect) {
                paymentMethodSelect.value = 'Efectivo';
            }

            const changeBtn = document.getElementById('change-client-btn');
            if (changeBtn) {
                changeBtn.addEventListener('click', showClientModal);
            }
        });
    }

// --- L√ìGICA DE NUEVOS MODALES ---

function showDiscountModal() {
    const subtotalBruto = Object.values(saleItems).reduce((sum, item) => sum + (item.cantidad * item.precio), 0);
    if (subtotalBruto === 0) {
        alert('No hay productos en la venta para aplicar un descuento.');
        return;
    }

    document.getElementById('discount-subtotal-display').textContent = formatCurrency(subtotalBruto);
    document.getElementById('discount-value-modal').value = 0;
    document.getElementById('discount-type-modal').value = 'percentage';
    
    const updatePreview = () => {
        const type = document.getElementById('discount-type-modal').value;
        const value = parseFloat(document.getElementById('discount-value-modal').value) || 0;
        let calculatedDiscount = 0;

        if (type === 'percentage') {
            calculatedDiscount = subtotalBruto * (value / 100);
        } else { // fixed
            calculatedDiscount = value;
        }
        calculatedDiscount = Math.min(calculatedDiscount, subtotalBruto); // No puede ser mayor al subtotal

        document.getElementById('discount-applied-display').textContent = formatCurrency(calculatedDiscount);
        document.getElementById('discount-new-subtotal-display').textContent = formatCurrency(subtotalBruto - calculatedDiscount);
    };


    document.getElementById('discount-type-modal').oninput = updatePreview;
    document.getElementById('discount-value-modal').oninput = updatePreview;
    
    updatePreview(); // Llamada inicial
    discountModal.show();
}

document.getElementById('confirm-discount-btn').addEventListener('click', () => {
    const subtotalBruto = Object.values(saleItems).reduce((sum, item) => sum + (item.cantidad * item.precio), 0);
    const type = document.getElementById('discount-type-modal').value;
    const value = parseFloat(document.getElementById('discount-value-modal').value) || 0;

    if (type === 'percentage') {
        discount = subtotalBruto * (value / 100);
    } else {
        discount = value;
    }

    if (discount > subtotalBruto) {
        alert('El descuento no puede ser mayor que el subtotal.');
        discount = 0;
        return;
    }

    discountModal.hide();
    updateUI();
});

function renderSplitPayments() {
    const list = document.getElementById('split-payments-list');
    const totalDue = parseFloat(document.getElementById('payment-total-display').textContent.replace(/[^\d.-]/g, ''));
    list.innerHTML = '';
    let totalPaid = 0;

    splitPayments.forEach((p, index) => {
        totalPaid += p.amount;
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.innerHTML = `
            <span><i class="bi bi-cash-coin"></i> ${p.method}</span>
            <span class="fw-bold">${formatCurrency(p.amount)}</span>
            <button class="btn btn-sm btn-outline-danger" onclick="removeSplitPayment(${index})"><i class="bi bi-trash"></i></button>
        `;
        list.appendChild(item);
    });

    const remaining = totalDue - totalPaid;
    const change = totalPaid - totalDue;

    document.getElementById('payment-remaining-display').textContent = formatCurrency(Math.max(0, remaining));
    document.getElementById('payment-change-display').textContent = formatCurrency(Math.max(0, change));
    document.getElementById('confirm-payment-btn').disabled = remaining > 0;
}

function removeSplitPayment(index) {
    splitPayments.splice(index, 1);
    renderSplitPayments();
}

document.getElementById('add-split-payment-btn').addEventListener('click', () => {
    const method = document.getElementById('split-payment-method').value;
    const amountInput = document.getElementById('split-payment-amount');
    const amount = parseFloat(amountInput.value);

    if (isNaN(amount) || amount <= 0) {
        alert('Por favor, ingrese un monto v√°lido.');
        return;
    }

    splitPayments.push({ method, amount });
    renderSplitPayments();
    amountInput.value = '';
});

function showPaymentModal() {
    if (Object.keys(saleItems).length === 0) {
        alert('No hay productos para finalizar la venta.');
        return;
    }

    // Resetear pagos divididos
    splitPayments = [];

    const subtotalBruto = Object.values(saleItems).reduce((sum, item) => sum + (item.cantidad * item.precio), 0);
    const subtotalDescontado = subtotalBruto - discount;

    // Usar el subtotal descontado como base para el ITBIS
    const itbisIncluido = subtotalDescontado - (subtotalDescontado / (1 + ITBIS_RATE));
    const baseImponible = subtotalDescontado - itbisIncluido;

    document.getElementById('payment-subtotal-display').textContent = formatCurrency(subtotalBruto);
    document.getElementById('payment-discount-display').textContent = `- ${formatCurrency(discount)}`;
    document.getElementById('payment-itbis-display').textContent = formatCurrency(itbisIncluido);
    document.getElementById('payment-total-display').textContent = formatCurrency(subtotalDescontado);
    
    // Sugerir el monto restante en el campo de pago dividido
    document.getElementById('split-payment-amount').value = subtotalDescontado.toFixed(2);

    renderSplitPayments();
    paymentModal.show();
}

document.getElementById('confirm-payment-btn').addEventListener('click', () => {
    let tempClientName = null;
    const hasCreditPayment = splitPayments.some(p => p.method === 'Cr√©dito');
    // Si hay pago a cr√©dito pero no hay cliente seleccionado, ofrecer capturar nombre (opcional ahora)
    if (hasCreditPayment && !selectedClient) {
        const response = prompt('Venta a cr√©dito sin cliente espec√≠fico.\n\n(Opcional) Ingrese un nombre o referencia. Podr√° completar el cliente despu√©s:');
        tempClientName = response && response.trim() !== '' ? response.trim() : null;
    }
    finalizeSale(splitPayments, tempClientName);
});

    // Eventos de botones de acci√≥n
    if (modifyQtyBtn) {
        modifyQtyBtn.addEventListener('click', () => {
            const selectedItems = document.querySelectorAll('.item-checkbox:checked');
            if (selectedItems.length === 0) return;

            const newQty = prompt('Nueva cantidad para productos seleccionados:');
            if (!newQty || isNaN(newQty) || newQty <= 0) {
                alert('Cantidad inv√°lida');
                return;
            }

            selectedItems.forEach(checkbox => {
                const itemId = checkbox.getAttribute('data-id');
                const item = saleItems[itemId];
                if (newQty <= item.stock) {
                    updateQuantity(itemId, newQty);
                } else {
                    alert(`Stock insuficiente para ${item.nombre}. M√°ximo: ${item.stock}`);
                }
            });
        });
    }

    if (deleteItemBtn) {
        deleteItemBtn.addEventListener('click', () => {
            const selectedItems = document.querySelectorAll('.item-checkbox:checked');
            if (selectedItems.length === 0) return;

            if (confirm(`¬øEst√° seguro de eliminar ${selectedItems.length} producto(s) seleccionado(s)?`)) {
                selectedItems.forEach(checkbox => {
                    const itemId = checkbox.getAttribute('data-id');
                    delete saleItems[itemId];
                });
                updateUI();
            }
        });
    }

    if (returnItemBtn) {
        returnItemBtn.addEventListener('click', showReturnModal);
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('.item-checkbox').forEach(cb => {
                cb.checked = isChecked;
                const itemId = cb.getAttribute('data-id');
                handleItemSelection(itemId, isChecked);
            });
        });
    }

    if (discountBtn) {
        discountBtn.addEventListener('click', showDiscountModal);
    }

    if (cancelSaleBtn) {
        cancelSaleBtn.addEventListener('click', () => {
            if (Object.keys(saleItems).length > 0 && confirm('¬øEst√° seguro de que desea cancelar la venta actual?')) {
                clearSale();
            }
        });
    }

    if (finalizeSaleBtn) {
        finalizeSaleBtn.addEventListener('click', () => {
            if (Object.keys(saleItems).length === 0) {
                alert('No hay productos para finalizar la venta.');
                return;
            }
            const paymentMethod = paymentMethodSelect.value;
            // Si es cr√©dito sin cliente, preguntar por nombre y procesar directamente
            if (paymentMethod === 'Cr√©dito' && !selectedClient) {
                const clientName = prompt('Venta a cr√©dito sin cliente espec√≠fico.\n\n(Opcional) Ingrese un nombre o referencia:');
                // Procesar directamente con pago 100% a cr√©dito
                const payments = [{ method: 'Cr√©dito', amount: 0 }]; // El monto se calcular√° en finalizeSale
                finalizeSale(payments, clientName);
            } else {
                // Para otros casos, mostrar modal de pago (permite pago dividido)
                showPaymentModal();
            }
        });
    }

    // Bot√≥n para ver ventas pausadas
    const viewHeldSalesBtn = document.getElementById('view-held-sales-btn');
    if (viewHeldSalesBtn) {
        viewHeldSalesBtn.addEventListener('click', () => heldSalesModal.show());
    }

    // --- Funcionalidad de Pausar Venta ---
    const holdSaleBtn = document.getElementById('hold-sale-btn');
    if (holdSaleBtn) {
        holdSaleBtn.addEventListener('click', () => {
            if (Object.keys(saleItems).length === 0) {
                alert('No hay productos en la venta para pausar.');
                return;
            }

            const holdNote = prompt('Nota para venta en pausa (opcional):');
            const saleId = `hold_${Date.now()}`;

            const holdData = {
                id: saleId,
                items: saleItems,
                client: selectedClient,
                discount: discount,
                timestamp: new Date().toISOString(),
                note: holdNote || ''
            };

            // Guardar en localStorage
            localStorage.setItem(saleId, JSON.stringify(holdData));

            // Mostrar confirmaci√≥n y limpiar venta
            alert(`Venta pausada con ID: ${saleId}\n\nPodr√°s recuperar esta venta m√°s tarde.`);
            clearSale();

            // Actualizar contador y lista de ventas pausadas
            updateHoldList();
        });
    }

    // REMOVIDO: Ya no resaltar cliente para Cr√©dito - ahora es opcional
    // Las ventas a cr√©dito pueden procesarse sin cliente seleccionado

    // Atajos de teclado
    document.addEventListener('keydown', (e) => {
        if (e.key === 'F12') {
            e.preventDefault();
            finalizeSale();
        }
        if (e.key === 'Escape') {
            e.preventDefault();
            if (cancelSaleBtn) cancelSaleBtn.click();
        }
    });

    // Actualizar la lista de ventas pausadas al cargar la p√°gina
    updateHoldList();
}

// --- Funciones Principales ---
function formatCurrency(value) {
    return new Intl.NumberFormat('es-DO', { style: 'currency', currency: 'DOP' }).format(value);
}

function addProductToSale(product) {
    if (product.stock <= 0) {
        alert(`El producto '${product.nombre}' no tiene stock disponible.`);
        return;
    }
    if (saleItems[product.id]) {
        if (saleItems[product.id].cantidad >= product.stock) {
            alert(`No hay m√°s stock disponible para '${product.nombre}'.`);
            return;
        }
        saleItems[product.id].cantidad++;
    } else {
        saleItems[product.id] = { ...product, cantidad: 1 };
    }
    updateUI();
}

function selectClient(client) {
    selectedClient = client;

    // Actualizar display en el panel izquierdo
    if (clientDisplayDiv) {
        clientDisplayDiv.innerHTML = `<strong>Cliente:</strong> ${client.nombre}`;
    }

    // Actualizar display en el panel derecho de resumen
    if (clientSummaryDiv) {
        clientSummaryDiv.innerHTML = `
            <div class="client-avatar">
                <i class="bi bi-person-fill"></i>
            </div>
            <div class="client-details">
                <div class="client-name">${client.nombre}</div>
                <button class="change-client-btn" id="change-client-btn">
                    <i class="bi bi-pencil"></i> Cambiar
                </button>
            </div>
        `;
    }

    if (clearClientBtn) {
        clearClientBtn.style.display = 'inline-block';
    }

    // Re-asignar evento para cambiar cliente
    const changeBtn = document.getElementById('change-client-btn');
    if (changeBtn) {
        changeBtn.addEventListener('click', showClientModal);
    }
}

function toggleItemSelection(itemId) {
    const itemCard = document.querySelector(`.item-card[data-id="${itemId}"]`);
    if (itemCard) {
        const checkbox = itemCard.querySelector('.item-checkbox');
        if (checkbox) {
            checkbox.checked = !checkbox.checked;
            handleItemSelection(itemId, checkbox.checked);
        }
    }
}

function handleItemSelection(itemId, isSelected) {
    const itemCard = document.querySelector(`.item-card[data-id="${itemId}"]`);
    if (itemCard) {
        if (isSelected) {
            itemCard.classList.add('selected');
        } else {
            itemCard.classList.remove('selected');
        }
    }
    updateSelectionButtons();
}

function updateSelectionButtons() {
    const selectedCount = document.querySelectorAll('.item-checkbox:checked').length;

    if (modifyQtyBtn) modifyQtyBtn.disabled = selectedCount === 0;
    if (deleteItemBtn) deleteItemBtn.disabled = selectedCount === 0;
    if (returnItemBtn) returnItemBtn.disabled = selectedCount === 0;
}

function updateQuantity(id, newQuantity) {
    const qty = parseInt(newQuantity);
    if (qty > 0 && qty <= saleItems[id].stock) {
        saleItems[id].cantidad = qty;
    } else if (qty > saleItems[id].stock) {
        alert(`Stock m√°ximo para este producto es ${saleItems[id].stock}`);
        saleItems[id].cantidad = saleItems[id].stock;
    } else {
        delete saleItems[id];
    }
    updateUI();
}

function removeItem(id) {
    delete saleItems[id];
    updateUI();
}

function clearSale() {
    saleItems = {};
    discount = 0.0;
    if (clearClientBtn) clearClientBtn.click();
    updateUI();
}

// Variable global para guardar el ID de la venta actual (si es a cr√©dito sin cliente)
let currentCreditSaleId = null;

async function finalizeSale(payments, tempClientName = null) {
    const confirmBtn = document.getElementById('confirm-payment-btn');
    const finalizeBtn = document.getElementById('finalize-sale-btn');

    if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';
    }
    if (finalizeBtn) finalizeBtn.disabled = true;

    try {
        const response = await fetch('/api/pos/register_sale', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                items: Object.values(saleItems),
                client_id: selectedClient ? selectedClient._id : null,
                payments: payments,
                discount: discount,
                temp_client_name: tempClientName
            })
        });

        const result = await response.json();
        if (result.success) {
            // Solo cerrar modal si est√° visible
            if (document.getElementById('paymentModal').classList.contains('show')) {
                paymentModal.hide();
            }
            
            const totalPaid = splitPayments && splitPayments.length > 0 
                ? splitPayments.reduce((sum, p) => sum + p.amount, 0)
                : 0;
            const totalDueText = document.getElementById('payment-total-display');
            const totalDue = totalDueText 
                ? parseFloat(totalDueText.textContent.replace(/[^\d.-]/g, ''))
                : 0;

            printTicket(result.sale_id, totalPaid, totalPaid - totalDue);
            
            // Si fue venta a cr√©dito SIN cliente, guardar el ID y mostrar modal para asociar cliente despu√©s
            const hasCreditPayment = payments.some(p => p.method === 'Cr√©dito');
            if (hasCreditPayment && !selectedClient) {
                currentCreditSaleId = result.sale_id;
                alert('Venta a cr√©dito registrada exitosamente. Ahora puedes asociar un cliente.');
                clearSale();
                // Mostrar modal para actualizar cliente
                setTimeout(() => {
                    const updateModal = new bootstrap.Modal(document.getElementById('updateCreditClientModal'));
                    updateModal.show();
                }, 500);
            } else {
                alert(result.message);
                clearSale();
            }
        } else {
            alert(`Error al registrar la venta: ${result.error}`);
        }
    } catch (error) {
        alert('Error de conexi√≥n al registrar la venta.');
    } finally {
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="bi bi-check-circle"></i> Confirmar Venta';
        }
    }
}

function printTicket(saleId, amountReceived = null, change = null) {
    try {
        // Construir URL para impresi√≥n con datos de la venta
        const printUrl = `/api/pos/print_ticket/${saleId}`;
        window.open(printUrl, '_blank', 'width=400,height=600,scrollbars=yes,resizable=yes');
    } catch (error) {
        console.error('Error abriendo ventana de impresi√≥n:', error);
    }
}

function updateUI() {
    if (!saleItemsContainer) return;

    saleItemsContainer.innerHTML = '';
    let subtotalBruto = 0;
    let totalUnidades = 0;
    const itemIds = Object.keys(saleItems);

    if (itemIds.length === 0) {
        const emptyMessage = document.getElementById('empty-cart-message');
        if (emptyMessage) emptyMessage.style.display = 'block';
        if (saleItemsContainer) saleItemsContainer.style.display = 'none';
    } else {
        const emptyMessage = document.getElementById('empty-cart-message');
        if (emptyMessage) emptyMessage.style.display = 'none';
        if (saleItemsContainer) saleItemsContainer.style.display = 'block';

        itemIds.forEach(id => {
            const item = saleItems[id];
            const subtotal = item.cantidad * item.precio;
            subtotalBruto += subtotal;
            totalUnidades += item.cantidad;

            const itemCard = document.createElement('div');
            itemCard.className = 'item-card';
            itemCard.dataset.id = id;
            itemCard.onclick = () => toggleItemSelection(id);

            itemCard.innerHTML = `
                <input type="checkbox" class="item-checkbox" data-id="${id}"
                       onchange="handleItemSelection('${id}', this.checked)">
                <div class="item-image">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="item-details">
                    <div class="item-name">${item.nombre}</div>
                    <div class="item-meta">Stock: ${item.stock}</div>
                </div>
                <div class="item-quantity">
                    <input type="number" class="quantity-input" value="${item.cantidad}"
                           min="1" max="${item.stock}" onchange="updateQuantity('${id}', this.value)">
                </div>
                <div class="item-price">${formatCurrency(item.precio)}</div>
                <div class="item-subtotal">${formatCurrency(subtotal)}</div>
                <div class="item-actions">
                    <button class="action-btn remove" onclick="event.stopPropagation(); removeItem('${id}')">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;

            saleItemsContainer.appendChild(itemCard);
        });
    }

    // Calcular totales
    const subtotalDescontado = subtotalBruto - discount;
    const baseImponible = subtotalDescontado / (1 + ITBIS_RATE);
    const itbisIncluido = subtotalDescontado - baseImponible;

    if (subtotalBaseSpan) subtotalBaseSpan.textContent = formatCurrency(baseImponible);
    if (discountDisplaySpan) discountDisplaySpan.textContent = `- ${formatCurrency(discount)}`;
    if (itbisSpan) itbisSpan.textContent = formatCurrency(itbisIncluido);
    if (totalSpan) totalSpan.textContent = formatCurrency(subtotalDescontado);

    if (totalItemsLabel) totalItemsLabel.textContent = `${itemIds.length} items`;
    if (totalUnitsLabel) totalUnitsLabel.textContent = `${totalUnidades} unidades`;

    // Deshabilitar precio si hay descuento aplicado
    const discountRow = document.getElementById('discount-row');
    if (discountRow) {
        discountRow.style.display = discount > 0 ? 'flex' : 'none';
    }

    updateSelectionButtons();
}

async function renderFrequentProducts() {
    const dropdownList = document.getElementById('frequent-products-list');
    if (!dropdownList) return;

    // Lista de IDs de productos frecuentes (esto podr√≠a venir de una API en el futuro)
    const frequentProductIds = [
        "692ee81c966500d603a5b3df", 
        "692ee829d040180750a5b1d3", 
        "692ee830d040180750a5b266", 
        "692ee832d040180750a5b295", 
        "692ee837d040180750a5b303", 
        "692ee839d040180750a5b32b", 
    ];

    try {
        const response = await fetch('/api/products');
        const allProducts = await response.json();
        const productMap = new Map(allProducts.map(p => [p.id, p]));

        dropdownList.innerHTML = ''; // Limpiar el loader

        frequentProductIds.forEach(id => {
            const product = productMap.get(id);
            if (product) {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.className = 'dropdown-item';
                link.href = '#';
                link.innerHTML = `${product.nombre} <span class="text-muted small">${formatCurrency(product.precio)}</span>`;
                link.onclick = (e) => {
                    e.preventDefault();
                    addProductToSale(product);
                };
                listItem.appendChild(link);
                dropdownList.appendChild(listItem);
            }
        });

        if (dropdownList.innerHTML === '') {
            dropdownList.innerHTML = '<li><a class="dropdown-item text-muted" href="#">No hay productos frecuentes.</a></li>';
        }

    } catch (error) {
        console.error("Error cargando productos frecuentes:", error);
        dropdownList.innerHTML = '<li><a class="dropdown-item text-danger" href="#">Error al cargar.</a></li>';
    }
}

async function performProductSearch(term) {
    if (!productResultsDiv) return;

    try {
        const response = await fetch('/api/search_products', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ term })
        });
        const data = await response.json();

        productResultsDiv.innerHTML = '';
        if (data.success) {
            if (data.products.length === 0) {
                productResultsDiv.innerHTML = '<div class="list-group-item text-muted">No se encontraron productos.</div>';
                return;
            }
            data.products.forEach(product => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.textContent = `${product.nombre} (Stock: ${product.stock}) - ${formatCurrency(product.precio)}`;
                item.onclick = (e) => {
                    e.preventDefault();
                    addProductToSale(product);
                    if (productSearchInput) productSearchInput.value = '';
                    productResultsDiv.innerHTML = '';
                };
                productResultsDiv.appendChild(item);
            });
        } else {
            productResultsDiv.innerHTML = '<div class="list-group-item text-danger">Error al buscar productos.</div>';
        }
    } catch (error) {
        console.error('Error searching products:', error);
        productResultsDiv.innerHTML = '<div class="list-group-item text-danger">Error de conexi√≥n.</div>';
    }
}

async function performClientSearch(term) {
    if (!clientResultsDiv) return;

    try {
        const response = await fetch('/api/search_clients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ term })
        });

        const data = await response.json();
        clientResultsDiv.innerHTML = '';

        if (data.success && data.clients) {
            data.clients.forEach(client => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.textContent = `${client.nombre} (${client.rnc_cedula})`;
                item.onclick = (e) => {
                    e.preventDefault();
                    selectClient(client);
                    if (clientSearchInput) clientSearchInput.value = '';
                    clientResultsDiv.innerHTML = '';
                };
                clientResultsDiv.appendChild(item);
            });
        }
    } catch (error) {
        console.error('Error searching clients:', error);
    }
}

function showClientModal() {
    const modal = new bootstrap.Modal(document.getElementById('clientModal'));
    if (modal) {
        modal.show();

        const clientSearchModal = document.getElementById('client-search-modal');
        if (clientSearchModal) {
            clientSearchModal.addEventListener('keyup', async (e) => {
                const term = e.target.value;
                if (term.length < 2) {
                    const clientResultsModal = document.getElementById('client-results-modal');
                    if (clientResultsModal) clientResultsModal.innerHTML = '';
                    return;
                }

                try {
                    const response = await fetch('/api/search_clients', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ term })
                    });

                    const data = await response.json();
                    const clientResultsModal = document.getElementById('client-results-modal');
                    if (clientResultsModal) {
                        clientResultsModal.innerHTML = '';

                        if (data.success && data.clients.length > 0) {
                            data.clients.forEach(client => {
                                const clientCard = document.createElement('div');
                                clientCard.className = 'client-card p-3 border-bottom';
                                clientCard.innerHTML = `
                                    <div class="client-info">
                                        <strong>${client.nombre}</strong><br>
                                        <small class="text-muted">RNC/C√©dula: ${client.rnc_cedula}</small>
                                    </div>
                                    <button class="btn btn-primary btn-sm select-client-btn" data-client='${JSON.stringify(client)}'>
                                        Seleccionar
                                    </button>
                                `;
                                clientResultsModal.appendChild(clientCard);

                                const selectBtn = clientCard.querySelector('.select-client-btn');
                                if (selectBtn) {
                                    selectBtn.addEventListener('click', () => {
                                        selectClient(client);
                                        modal.hide();
                                    });
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error searching clients:', error);
                }
            });

            clientSearchModal.focus();
        }
    }
}

function showReturnModal() {
    const selectedItems = document.querySelectorAll('.item-checkbox:checked');
    if (selectedItems.length === 0) return;

    const modal = new bootstrap.Modal(document.getElementById('returnsModal'));
    const returnItemsList = document.getElementById('return-items-list');

    if (modal && returnItemsList) {
        returnItemsList.innerHTML = '';

        selectedItems.forEach(checkbox => {
            const itemId = checkbox.getAttribute('data-id');
            const item = saleItems[itemId];

            if (item.cantidad > 1) {
                returnItemsList.innerHTML += `
                    <div class="return-item-card d-flex justify-content-between align-items-center p-2 border-bottom">
                        <div>
                            <strong>${item.nombre}</strong><br>
                            <small>Disponible: ${item.stock}</small>
                        </div>
                        <input type="number" class="form-control form-control-sm" style="width: 80px;"
                               value="${item.cantidad}" min="1" max="${item.cantidad}" data-item-id="${itemId}">
                    </div>
                `;
            } else {
                returnItemsList.innerHTML += `
                    <div class="return-item-card d-flex justify-content-between align-items-center p-2 border-bottom">
                        <div>
                            <strong>${item.nombre}</strong><br>
                            <small>Disponible: ${item.stock}</small>
                        </div>
                        <span class="badge bg-warning">1 unidad</span>
                    </div>
                `;
            }
        });

        // Calcular total a devolver
        const totalReturn = Array.from(selectedItems).reduce((sum, checkbox) => {
            const itemId = checkbox.getAttribute('data-id');
            return sum + (saleItems[itemId].cantidad * saleItems[itemId].precio);
        }, 0);

        returnItemsList.innerHTML += `
            <div class="mt-3 p-3 bg-light rounded">
                <strong>Total a devolver: ${formatCurrency(totalReturn)}</strong>
            </div>
        `;

        modal.show();

        // Configurar evento para confirmar devoluci√≥n
        const confirmReturnBtn = document.getElementById('confirm-return-btn');
        if (confirmReturnBtn) {
            if (!confirmReturnBtn.dataset.listenerAttached) {
                confirmReturnBtn.dataset.listenerAttached = 'true';
                confirmReturnBtn.addEventListener('click', async () => {
                    const returnReason = document.getElementById('return-reason').value;
                    const itemsToReturn = [];

                    document.querySelectorAll('#return-items-list .return-item-card').forEach(card => {
                        const input = card.querySelector('input[type="number"]');
                        const itemId = input.dataset.itemId;
                        const quantity = parseInt(input.value);
                        const itemData = saleItems[itemId];

                        if (itemData && quantity > 0) {
                            itemsToReturn.push({
                                producto_id: itemData.id,
                                cantidad: quantity,
                                precio: itemData.precio
                            });
                        }
                    });

                    try {
                        const response = await fetch('/api/pos/process_return', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ items: itemsToReturn, reason: returnReason })
                        });
                        const result = await response.json();
                        showToast(result.message || result.error, !result.success);
                        if (result.success) {
                            // Remover los items devueltos del carrito actual
                            itemsToReturn.forEach(returnedItem => delete saleItems[returnedItem.producto_id]);
                            updateUI();
                            modal.hide();
                        }
                    } catch (error) {
                        showToast('Error de red al procesar la devoluci√≥n.', true);
                    }
                });
            }
        }
    }
}

// Funci√≥n para actualizar lista de ventas pausadas
function updateHoldList() {
    const holdListContainer = document.getElementById('hold-list-container');
    const noHeldSalesMessage = document.getElementById('no-held-sales-message');
    const heldSalesCountBadge = document.getElementById('held-sales-count');

    if (!holdListContainer) return;

    holdListContainer.innerHTML = '';
    let count = 0;

    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('hold_')) {
            count++;
            try {
                const holdData = JSON.parse(localStorage.getItem(key));
                const holdItem = document.createElement('div');
                holdItem.className = 'list-group-item list-group-item-action flex-column align-items-start';
                holdItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Venta Pausada #${key.split('_')[1]}</h6>
                            <small class="text-muted">
                                ${new Date(holdData.timestamp).toLocaleString('es')} - ${Object.keys(holdData.items).length} items
                            </small>
                            ${holdData.client ? `<div class="mt-1"><small><strong>Cliente:</strong> ${holdData.client.nombre}</small></div>` : ''}
                            ${holdData.note ? `<div class="mt-1 fst-italic"><small>"${holdData.note}"</small></div>` : ''}
                        </div>
                        <div>
                            <button class="btn btn-primary btn-sm me-2" onclick="resumeSale('${key}')" title="Continuar esta venta">
                                <i class="bi bi-play-circle-fill"></i> Continuar
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteHoldSale('${key}')" title="Eliminar esta venta pausada">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </div>
                `;
                holdListContainer.appendChild(holdItem);
            } catch (e) {
                console.error('Error parsing hold data:', e);
            }
        }
    }

    // Actualizar UI
    if (count > 0) {
        if (noHeldSalesMessage) noHeldSalesMessage.style.display = 'none';
        if (heldSalesCountBadge) {
            heldSalesCountBadge.textContent = count;
            heldSalesCountBadge.style.display = 'inline-block';
        }
    } else {
        if (noHeldSalesMessage) noHeldSalesMessage.style.display = 'block';
        if (heldSalesCountBadge) {
            heldSalesCountBadge.style.display = 'none';
        }
    }
}

// Funci√≥n para continuar venta pausada
function resumeSale(holdKey) {
    const holdData = JSON.parse(localStorage.getItem(holdKey));
    saleItems = holdData.items;
    selectedClient = holdData.client;
    discount = holdData.discount;

    localStorage.removeItem(holdKey);
    heldSalesModal.hide();
    updateUI();
    updateHoldList();

    // Actualizar display del cliente
    if (selectedClient) {
        selectClient(selectedClient);
    }

    alert(`Venta recuperada. ${Object.keys(saleItems).length} productos cargados.`);
}

// Funci√≥n para eliminar venta pausada
function deleteHoldSale(holdKey) {
    if (confirm('¬øEst√° seguro de eliminar esta venta pausada?')) {
        localStorage.removeItem(holdKey);
        updateHoldList();
    }
}

// Funci√≥n para limpiar selecci√≥n de cliente desde modal
function clearClientSelection() {
    const clientSearchModal = document.getElementById('client-search-modal');
    const clientResultsModal = document.getElementById('client-results-modal');

    selectedClient = null;
    if (clientSearchModal) clientSearchModal.value = '';
    if (clientResultsModal) clientResultsModal.innerHTML = '';

    // Reset panels
    if (clearClientBtn) clearClientBtn.click();
}

// ===== FUNCIONALIDAD PARA ACTUALIZAR CLIENTE EN VENTA A CR√âDITO =====
// Modal de actualizar cliente
const updateCreditClientModal = new bootstrap.Modal(document.getElementById('updateCreditClientModal'));
const updateClientSearchInput = document.getElementById('update-client-search');
const clearUpdateClientBtn = document.getElementById('clear-update-client-btn');
const updateClientResultsDiv = document.getElementById('update-client-results');
const confirmUpdateCreditClientBtn = document.getElementById('confirm-update-credit-client-btn');

let selectedUpdateClient = null; // Cliente seleccionado en el modal de actualizaci√≥n

// Buscar cliente en el modal de actualizaci√≥n
if (updateClientSearchInput) {
    updateClientSearchInput.addEventListener('input', async (e) => {
        const searchTerm = e.target.value.trim();
        if (searchTerm.length < 2) {
            updateClientResultsDiv.innerHTML = '';
            selectedUpdateClient = null;
            confirmUpdateCreditClientBtn.disabled = true;
            return;
        }

        try {
            const response = await fetch(`/api/clients/search?q=${encodeURIComponent(searchTerm)}`);
            const result = await response.json();
            
            if (result.success && result.clients.length > 0) {
                updateClientResultsDiv.innerHTML = '';
                result.clients.forEach(client => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'list-group-item list-group-item-action cursor-pointer';
                    itemDiv.style.cursor = 'pointer';
                    itemDiv.innerHTML = `
                        <strong>${client.nombre}</strong><br>
                        <small class="text-muted">RNC: ${client.rnc || 'N/A'} | Tel√©fono: ${client.telefono || 'N/A'}</small>
                    `;
                    itemDiv.addEventListener('click', () => {
                        selectedUpdateClient = client;
                        updateClientSearchInput.value = client.nombre;
                        updateClientResultsDiv.innerHTML = '';
                        confirmUpdateCreditClientBtn.disabled = false;
                    });
                    updateClientResultsDiv.appendChild(itemDiv);
                });
            } else {
                updateClientResultsDiv.innerHTML = '<p class="text-muted text-center py-3">No se encontraron clientes</p>';
                selectedUpdateClient = null;
                confirmUpdateCreditClientBtn.disabled = true;
            }
        } catch (error) {
            console.error('Error buscando cliente:', error);
            updateClientResultsDiv.innerHTML = '<p class="text-danger text-center py-3">Error al buscar clientes</p>';
        }
    });
}

// Limpiar b√∫squeda
if (clearUpdateClientBtn) {
    clearUpdateClientBtn.addEventListener('click', () => {
        updateClientSearchInput.value = '';
        updateClientResultsDiv.innerHTML = '';
        selectedUpdateClient = null;
        confirmUpdateCreditClientBtn.disabled = true;
    });
}

// Confirmar actualizaci√≥n de cliente
if (confirmUpdateCreditClientBtn) {
    confirmUpdateCreditClientBtn.addEventListener('click', async () => {
        if (!currentCreditSaleId || !selectedUpdateClient) {
            alert('Error: No hay venta o cliente seleccionado');
            return;
        }

        confirmUpdateCreditClientBtn.disabled = true;
        confirmUpdateCreditClientBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Actualizando...';

        try {
            const response = await fetch('/api/pos/update_sale_client', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sale_id: currentCreditSaleId,
                    client_id: selectedUpdateClient._id
                })
            });

            const result = await response.json();
            if (result.success) {
                alert('Cliente asociado exitosamente a la venta a cr√©dito.');
                updateCreditClientModal.hide();
                currentCreditSaleId = null;
                selectedUpdateClient = null;
                updateClientSearchInput.value = '';
                updateClientResultsDiv.innerHTML = '';
            } else {
                alert(`Error al actualizar: ${result.error}`);
            }
        } catch (error) {
            alert('Error de conexi√≥n al actualizar cliente');
        } finally {
            confirmUpdateCreditClientBtn.disabled = false;
            confirmUpdateCreditClientBtn.innerHTML = '<i class="bi bi-check-circle"></i> Asociar Cliente';
        }
    });
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
// QuaggaJS for POS Modal
window.posScanner = (function() {
    let isModalScannerActive = false;
    let lastScannedCodeModal = null;
    const modalViewport = document.getElementById('pos-scanner-viewport');
    const modalStatus = document.getElementById('pos-scanner-status');
    const modalVideo = modalViewport ? modalViewport.querySelector('video') : null;
    const modalCanvas = modalViewport ? modalViewport.querySelector('canvas') : null;

    function updateModalScannerStatus(message, type = 'secondary') {
        if (modalStatus) {
            modalStatus.innerHTML = `<i class="bi bi-circle-fill text-${type}"></i> ${message}`;
        }
    }

    const handleModalDetection = (result) => {
        const code = result.codeResult.code;

        if (code === lastScannedCodeModal) {
            return;
        }
        lastScannedCodeModal = code;
        updateModalScannerStatus('C√≥digo detectado - procesando...', 'info');

        // Call the main POS function to add product
        // processBarcodeScanForPOS is defined in the main script block of pos.html
        if (typeof processBarcodeScanForPOS === 'function') {
            processBarcodeScanForPOS(code);
        } else {
            console.error("processBarcodeScanForPOS no est√° definida.");
        }

        setTimeout(() => {
            lastScannedCodeModal = null;
            if (modalStatus && modalStatus.textContent.includes('procesando')) {
                updateModalScannerStatus('Esc√°ner activo. Apunte al c√≥digo de barras.', 'primary');
            }
        }, 800); // Cooldown
    };

    function init() {
        if (isModalScannerActive) return;

        updateModalScannerStatus('Inicializando esc√°ner...', 'warning');

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: modalViewport,
                constraints: {
                    width: { min: 320 }, // Smaller for modal
                    height: { min: 240 },
                    facingMode: "environment"
                },
            },
            decoder: { readers: ["ean_reader", "code_128_reader", "upc_reader"] },
            locate: true,
            locator: { patchSize: "medium", halfSample: true },
            numOfWorkers: navigator.hardwareConcurrency || 4,
        }, function(err) {
            if (err) {
                console.error("Error al iniciar Quagga en modal:", err);
                updateModalScannerStatus('Error al iniciar esc√°ner', 'danger');
                return;
            }
            console.log("Esc√°ner de modal inicializado correctamente.");
            Quagga.start();
            isModalScannerActive = true;
            updateModalScannerStatus('Esc√°ner activo. Apunte al c√≥digo de barras.', 'primary');
        });

        Quagga.onDetected(handleModalDetection);
    }

    function stop() {
        if (isModalScannerActive) {
            Quagga.stop();
            isModalScannerActive = false;
            updateModalScannerStatus('Esc√°ner detenido', 'warning');
        }
    }

    return {
        init: init,
        stop: stop
    };
})();
</script>

<style>
/* Header del POS */
.pos-header {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 10px;
}

.pos-status .badge {
    font-size: 0.8rem;
}

/* Search Cards */
.search-section .search-card {
    display: flex;
    align-items: flex-start; /* Alinea al inicio para mejor distribuci√≥n vertical */
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}

.search-section .search-card:hover {
    border-color: #007bff;
    box-shadow: 0 4px 15px rgba(0,123,255,0.1);
}

.search-section .search-card.barcode-card {
    padding: 10px 15px;
}

.search-section .search-card.barcode-card .search-icon {
    width: 35px;
    height: 35px;
}

.search-section .search-card.barcode-card .search-input input {
    font-size: 0.9rem;
    padding: 0.375rem 0.5rem;
}

.search-section .search-card.barcode-card .search-input small {
    font-size: 0.75rem;
}

.search-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin-right: 15px;
}

.search-icon:has(.bi-upc-scan) { background: linear-gradient(45deg, #28a745, #20c997); }
.search-icon:has(.bi-search) { background: linear-gradient(45deg, #007bff, #6610f2); }

.search-input {
    flex: 1;
    position: relative; /* Clave para que los resultados se posicionen correctamente */
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1000;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    max-height: 200px;
    overflow-y: auto;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

/* Ocultar el contenedor de resultados cuando est√° vac√≠o para evitar la l√≠nea blanca */
.search-results:empty {
    display: none;
}

/* Client Selection */
.client-selection {
    display: flex;
    align-items: center;
    padding: 15px;

    background: white;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.client-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(45deg, #17a2b8, #6f42c1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin-right: 15px;
}

.client-display {
    border-left: 3px solid #007bff;
    padding-left: 15px;
}

.client-info-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #6c757d;
}

.client-info-placeholder i {
    font-size: 1.5rem;
    margin-bottom: 5px;
}

/* Sale Items Panel */
.sale-items-panel {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
}

.panel-title {
    margin: 0;
    color: #2c3e50;
    font-weight: 600;
}

.panel-stats {
    margin-left: auto;
    display: flex;
    gap: 10px;
}

.stat-badge {
    background: #f8f9fa;
    color: #495057;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.stat-badge#total-units-label {
    background-color: #e7f3ff;
    color: #0056b3;
    font-size: 0.9rem;
    font-weight: 700;
    border: 1px solid #b3d7ff;
}

.panel-tools {
    padding: 15px 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.tool-buttons {
    display: flex;
    gap: 8px;
}

.tool-btn {
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    background: white;
    color: #495057;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s ease;
}

.tool-btn:hover {
    background: #f8f9fa;
    border-color: #007bff;
    color: #007bff;
}

.tool-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.tool-btn.danger:hover {
    background: #f8d7da;
    border-color: #dc3545;
    color: #dc3545;
}

.tool-btn.warning:hover {
    background: #fff3cd;
    border-color: #ffc107;
    color: #ffc107;
}

.select-all-btn {
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    font-size: 0.9rem;
}

.items-container {
    max-height: 400px;
    overflow-y: auto;
}

.empty-cart {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-cart i {
    font-size: 4rem;
    margin-bottom: 15px;
    opacity: 0.3;
}

.empty-cart h5 {
    margin-bottom: 10px;
}

/* Checkout Panel */
.checkout-panel {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
    overflow: hidden;
}

.checkout-header {
    background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
    color: white;
    padding: 20px;
}

.checkout-title {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
}

.client-summary {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    align-items: center;
}

.client-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: linear-gradient(45deg, #28a745, #20c997);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin-right: 15px;
}

.client-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 2px;
}

.change-client-btn {
    background: none;
    border: none;
    color: #007bff;
    font-size: 0.8rem;
    cursor: pointer;
    padding: 2px 6px;
}

.financial-summary {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
}

.label {
    font-weight: 500;
    color: #495057;
}

.value {
    font-weight: 600;
    color: #2c3e50;
}

.value.discount {
    color: #28a745;
}

.value.tax {
    color: #6c757d;
}

.summary-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent 0%, #dee2e6 50%, transparent 100%);
    margin: 12px 0;
}

.label-total {
    font-size: 1.1rem;
    font-weight: 700;
    color: #2c3e50;
}

.value-total {
    font-size: 1.4rem;
    font-weight: 800;
    color: #007bff;
}

.payment-section {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
}

.payment-label {
    display: block;
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
}

.payment-select {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: white;
    font-size: 0.9rem;
    color: #495057;
}

.discount-section {
    padding: 15px 20px;
    border-bottom: 1px solid #e9ecef;
}

.discount-btn {
    width: 100%;
    padding: 10px;
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 6px;
    color: #856404;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.discount-btn:hover {
    background: #ffecb5;
    border-color: #ffb300;
}

.actions-section {
    padding: 20px;
}

.primary-action {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    border-radius: 10px;
    color: white;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.primary-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
}

.action-shortcut {
    background: rgba(255,255,255,0.2);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

.secondary-actions {
    display: flex;
    gap: 10px;
}

.secondary-action {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.secondary-action.cancel {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.secondary-action.cancel:hover {
    background: #f1aeb5;
}

.secondary-action.hold {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.secondary-action.hold:hover {
    background: #ffecb5;
}

.secondary-action.info {
    background: #cff4fc;
    color: #055160;
    border: 1px solid #b6effb;
}

.secondary-action.info:hover {
    background: #aeeaf8;
}

.returns-section {
    padding: 15px 20px;
    background: #f8f9fa;
}

/* ESC√ÅNER FLOTANTE EN POS */
.fab-scanner {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    cursor: pointer;
    z-index: 1000;
    transition: all 0.3s ease;
}

.fab-scanner:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
}

.fab-scanner:active {
    transform: scale(0.95);
}

.floating-scanner-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1050;
    animation: fadeIn 0.3s ease;
}

.floating-scanner-panel {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.floating-scanner-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    opacity: 0.8;
}

.btn-close:hover {
    opacity: 1;
}

.floating-scanner-body {
    padding: 20px;
    flex: 1;
    overflow-y: auto;
}

.scanner-mini-view {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 15px;
}

.floating-scanner-target {
    width: 100%;
    max-width: 280px;
    height: 210px;
    background: #343a40;
    border-radius: 6px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    position: relative;
    overflow: hidden;
}

.floating-scanner-target.auto-mode {
    background: linear-gradient(45deg, #007bff, #6610f2);
}

.floating-scanner-target.auto-mode::after {
    content: "C√°mara Autom√°tica Active";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.9rem;
    text-align: center;
}

.floating-scanner-controls {
    display: flex;
    gap: 10px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Items List Styles */
.items-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 0 20px 20px;
}

.item-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    display: flex;
    align-items: center;
    transition: all 0.2s ease;
    cursor: pointer;
}

.item-card:hover {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.1);
}

.item-card.selected {
    border-color: #007bff;
    background: #f8f9ff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.15);
}

.item-checkbox {
    width: 20px;
    height: 20px;
    margin-right: 12px;
}

.item-image {
    width: 40px;
    height: 40px;
    background: #f8f9fa;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    flex-shrink: 0;
}

.item-details {
    flex: 1;
}

.item-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 2px;
}

.item-meta {
    font-size: 0.85rem;
    color: #6c757d;
}

.item-quantity {
    display: flex;
    align-items: center;
    margin-right: 15px;
    min-width: 80px;
}

.quantity-input {
    width: 60px;
    text-align: center;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 4px;
    font-weight: 600;
}

.item-price {
    text-align: right;
    font-weight: 600;
    color: #495057;
    margin-right: 15px;
    min-width: 80px;
}

.item-subtotal {
    text-align: right;
    font-weight: 700;
    color: #007bff;
    min-width: 70px;
}

.item-actions {
    margin-left: 10px;
}

.action-btn {
    width: 30px;
    height: 30px;
    border: none;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s ease;
}

.action-btn.remove {
    background: #f8d7da;
    color: #721c24;
}

.action-btn.remove:hover {
    background: #f1aeb5;
}

/* Estilos para botones de cantidad en el carrito */
.item-subtotal .btn {
    width: 28px;
    height: 28px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    border-radius: 4px;
}

</style>

{% endblock %}
